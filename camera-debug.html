<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Camera Debug - Ultrasound Webex</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #1a1a1a; 
      color: #fff;
    }
    .debug-section { 
      margin: 20px 0; 
      padding: 15px; 
      border: 1px solid #333; 
      background: #2a2a2a;
    }
    video { 
      width: 320px; 
      height: 240px; 
      background: #000; 
      border: 1px solid #666;
    }
    button { 
      padding: 10px 20px; 
      margin: 10px; 
      background: #007acc; 
      color: white; 
      border: none; 
      cursor: pointer;
    }
    button:hover { background: #005a9e; }
    .log { 
      background: #000; 
      padding: 10px; 
      font-family: monospace; 
      white-space: pre-wrap; 
      max-height: 300px; 
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>üé• Camera Debug Tool</h1>
  
  <div class="debug-section">
    <h2>Authentication Status</h2>
    <div id="auth-status">Checking...</div>
    <button onclick="checkAuth()">Refresh Auth Status</button>
  </div>

  <div class="debug-section">
    <h2>Camera Permissions</h2>
    <div id="permission-status">Checking...</div>
    <button onclick="checkPermissions()">Check Permissions</button>
  </div>

  <div class="debug-section">
    <h2>Camera Test</h2>
    <video id="test-video" autoplay muted playsinline></video>
    <br>
    <button onclick="startCamera()">Start Camera</button>
    <button onclick="stopCamera()">Stop Camera</button>
  </div>

  <div class="debug-section">
    <h2>Available Devices</h2>
    <div id="devices-list">Loading...</div>
    <button onclick="listDevices()">Refresh Devices</button>
  </div>

  <div class="debug-section">
    <h2>Debug Log</h2>
    <div id="debug-log" class="log"></div>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <!-- Load auth system -->
  <script src="src/js/simple-auth-fixed.js"></script>

  <script>
    let currentStream = null;
    const debugLog = document.getElementById('debug-log');
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      debugLog.textContent += `[${timestamp}] ${message}\n`;
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      debugLog.textContent = '';
    }

    async function checkAuth() {
      try {
        log('üîç Checking authentication...');
        
        if (typeof isAuthenticated === 'function') {
          const authenticated = isAuthenticated();
          const user = getCurrentUser();
          const token = getAccessToken();
          
          document.getElementById('auth-status').innerHTML = `
            <strong>Authenticated:</strong> ${authenticated ? '‚úÖ Yes' : '‚ùå No'}<br>
            <strong>User:</strong> ${user ? user.displayName || user.email : 'None'}<br>
            <strong>Token:</strong> ${token ? (token.startsWith('demo_token_') ? 'Demo Token' : 'Real Token') : 'None'}
          `;
          
          log(`Auth Status: ${authenticated}, User: ${user?.displayName || 'None'}`);
        } else {
          document.getElementById('auth-status').innerHTML = '‚ùå Auth system not loaded';
          log('‚ùå Auth functions not available');
        }
      } catch (error) {
        log(`‚ùå Auth check failed: ${error.message}`);
        document.getElementById('auth-status').innerHTML = `‚ùå Error: ${error.message}`;
      }
    }

    async function checkPermissions() {
      try {
        log('üîç Checking camera permissions...');
        
        if (navigator.permissions) {
          const cameraPermission = await navigator.permissions.query({ name: 'camera' });
          const micPermission = await navigator.permissions.query({ name: 'microphone' });
          
          document.getElementById('permission-status').innerHTML = `
            <strong>Camera:</strong> ${cameraPermission.state} <br>
            <strong>Microphone:</strong> ${micPermission.state}
          `;
          
          log(`Permissions - Camera: ${cameraPermission.state}, Mic: ${micPermission.state}`);
        } else {
          document.getElementById('permission-status').innerHTML = 'Permissions API not supported';
          log('‚ö†Ô∏è Permissions API not supported');
        }
      } catch (error) {
        log(`‚ùå Permission check failed: ${error.message}`);
        document.getElementById('permission-status').innerHTML = `‚ùå Error: ${error.message}`;
      }
    }

    async function listDevices() {
      try {
        log('üîç Listing media devices...');
        
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        const audioDevices = devices.filter(device => device.kind === 'audioinput');
        
        let html = '<strong>Video Devices:</strong><br>';
        videoDevices.forEach((device, index) => {
          html += `${index + 1}. ${device.label || 'Unknown Camera'} (${device.deviceId.substr(0, 8)}...)<br>`;
        });
        
        html += '<br><strong>Audio Devices:</strong><br>';
        audioDevices.forEach((device, index) => {
          html += `${index + 1}. ${device.label || 'Unknown Microphone'} (${device.deviceId.substr(0, 8)}...)<br>`;
        });
        
        document.getElementById('devices-list').innerHTML = html;
        log(`Found ${videoDevices.length} cameras, ${audioDevices.length} microphones`);
        
      } catch (error) {
        log(`‚ùå Device enumeration failed: ${error.message}`);
        document.getElementById('devices-list').innerHTML = `‚ùå Error: ${error.message}`;
      }
    }

    async function startCamera() {
      try {
        log('üìπ Starting camera...');
        
        // Stop existing stream first
        if (currentStream) {
          stopCamera();
        }
        
        const constraints = {
          video: { 
            width: { ideal: 1280 }, 
            height: { ideal: 720 },
            facingMode: 'user'
          },
          audio: true
        };
        
        log(`Requesting media with constraints: ${JSON.stringify(constraints)}`);
        
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const videoElement = document.getElementById('test-video');
        videoElement.srcObject = currentStream;
        
        log('‚úÖ Camera started successfully');
        log(`Stream active: ${currentStream.active}`);
        log(`Video tracks: ${currentStream.getVideoTracks().length}`);
        log(`Audio tracks: ${currentStream.getAudioTracks().length}`);
        
        // Log track details
        currentStream.getVideoTracks().forEach((track, index) => {
          log(`Video track ${index}: ${track.label}, enabled: ${track.enabled}, muted: ${track.muted}`);
        });
        
      } catch (error) {
        log(`‚ùå Camera start failed: ${error.name} - ${error.message}`);
        
        if (error.name === 'NotAllowedError') {
          log('üí° Camera permission denied. Please allow camera access in browser settings.');
        } else if (error.name === 'NotFoundError') {
          log('üí° No camera device found. Please check camera connection.');
        } else if (error.name === 'NotReadableError') {
          log('üí° Camera is being used by another application.');
        }
      }
    }

    function stopCamera() {
      if (currentStream) {
        log('üõë Stopping camera...');
        currentStream.getTracks().forEach(track => {
          track.stop();
          log(`Stopped track: ${track.kind} - ${track.label}`);
        });
        currentStream = null;
        
        const videoElement = document.getElementById('test-video');
        videoElement.srcObject = null;
        
        log('‚úÖ Camera stopped');
      } else {
        log('‚ö†Ô∏è No active camera stream to stop');
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      log('üöÄ Camera Debug Tool initialized');
      
      // Wait a bit for auth system to load
      setTimeout(async () => {
        await checkAuth();
        await checkPermissions();
        await listDevices();
      }, 500);
    });

    // Handle page unload
    window.addEventListener('beforeunload', () => {
      stopCamera();
    });
  </script>
</body>
</html>
