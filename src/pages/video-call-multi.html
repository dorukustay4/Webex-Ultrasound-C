<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Window Video Call - Ultrasound Webex</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Webex SDK -->
  <script src="https://unpkg.com/webex@^2.60.0/umd/webex.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e2e8f0;
      overflow: hidden;
    }

    .video-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      height: 100vh;
      gap: 2px;
      background: #0a0a0a;
    }

    .video-window {
      position: relative;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .window-header {
      background: rgba(0, 0, 0, 0.8);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 10;
    }

    .window-title {
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }

    .status-indicator.offline {
      background: #6b7280;
      animation: none;
    }

    .status-indicator.connecting {
      background: #f59e0b;
    }

    .status-indicator.connected {
      background: #10b981;
      animation: none;
    }

    .status-indicator.error {
      background: #ef4444;
      animation: pulse 1s infinite;
    }

    .status-indicator.disconnected {
      background: #f59e0b;
      animation: pulse 1.5s infinite;
    }

    .window-controls {
      display: flex;
      gap: 0.5rem;
    }

    .control-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #e2e8f0;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .control-btn.active {
      background: rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }

    .control-btn.muted {
      background: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .control-btn.disabled {
      background: rgba(107, 114, 128, 0.2);
      color: #6b7280;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .control-btn.disabled:hover {
      background: rgba(107, 114, 128, 0.2);
      transform: none;
    }

    .video-content {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .video-element {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #1a1a1a;
    }

    .video-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      color: #6b7280;
      text-align: center;
      padding: 2rem;
    }

    .placeholder-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .placeholder-text {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .placeholder-subtitle {
      font-size: 0.9rem;
      opacity: 0.7;
    }

    /* Expert Supervisor Window */
    .expert-window {
      border-color: rgba(59, 130, 246, 0.3);
    }

    .expert-window .window-title {
      color: #3b82f6;
    }

    /* Resident Window */
    .resident-window {
      border-color: rgba(16, 185, 129, 0.3);
    }

    .resident-window .window-title {
      color: #10b981;
    }

    /* Ultrasound Window */
    .ultrasound-window {
      border-color: rgba(245, 158, 11, 0.3);
    }

    .ultrasound-window .window-title {
      color: #f59e0b;
    }

    /* Annotation Window */
    .annotation-window {
      border-color: rgba(168, 85, 247, 0.3);
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
    }

    .annotation-window .window-title {
      color: #a855f7;
    }

    .annotation-tools {
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tool-btn {
      background: rgba(168, 85, 247, 0.2);
      border: 1px solid rgba(168, 85, 247, 0.3);
      color: #a855f7;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .tool-btn:hover {
      background: rgba(168, 85, 247, 0.3);
      transform: translateY(-1px);
    }

    .tool-btn.active {
      background: rgba(168, 85, 247, 0.5);
      color: white;
    }

    .annotation-canvas {
      flex: 1;
      background: #1a1a2e;
      margin: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(168, 85, 247, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #a855f7;
      font-size: 0.9rem;
    }

    .meeting-controls {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 1rem;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      padding: 1rem 1.5rem;
      border-radius: 50px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
    }

    .meeting-control-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      position: relative;
    }

    .meeting-control-btn.mic {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .meeting-control-btn.mic.muted {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .meeting-control-btn.camera {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .meeting-control-btn.camera.disabled {
      background: rgba(107, 114, 128, 0.2);
      color: #6b7280;
    }

    .meeting-control-btn.screen-share {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .meeting-control-btn.screen-share.active {
      background: rgba(245, 158, 11, 0.5);
      color: white;
    }

    .meeting-control-btn.end-call {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
      position: relative;
      overflow: hidden;
    }

    .meeting-control-btn.end-call:hover {
      background: rgba(239, 68, 68, 0.4);
      color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
      transform: translateY(-2px) scale(1.05);
    }

    .meeting-control-btn.end-call:active {
      transform: translateY(-1px) scale(0.98);
      background: rgba(239, 68, 68, 0.6);
    }

    .meeting-control-btn.end-call::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    .meeting-control-btn.end-call:hover::before {
      width: 100%;
      height: 100%;
    }

    .meeting-control-btn:hover {
      transform: translateY(-2px) scale(1.05);
    }

    .meeting-info {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
    }

    .meeting-id {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }

    .meeting-timer {
      font-size: 1.1rem;
      font-weight: 600;
      color: #10b981;
    }

    .participants-count {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 100;
    }

    .participant-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes fadeIn {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }

    @keyframes scanLine {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100vh); }
    }

    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    @keyframes heartbeat {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }

    @media (max-width: 768px) {
      .video-grid {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(4, 1fr);
      }
      
      .meeting-controls {
        padding: 0.75rem 1rem;
        gap: 0.75rem;
      }
      
      .meeting-control-btn {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <!-- Meeting Info Display -->
  <div class="meeting-info">
    <div class="meeting-id">Meeting ID: <span id="meeting-id-display">Loading...</span></div>
    <div class="meeting-timer" id="meeting-timer">00:00:00</div>
  </div>

  <!-- Participants Count -->
  <div class="participants-count">
    <div class="participant-indicator"></div>
    <span id="participants-count">1 participant</span>
  </div>

  <!-- Four-Window Video Grid -->
  <div class="video-grid">
    <!-- Expert Supervisor Window (Top Left) -->
    <div class="video-window expert-window">
      <div class="window-header">
        <div class="window-title">
          <div class="status-indicator" id="expert-status"></div>
          Expert Supervisor (You)
        </div>
        <div class="window-controls">
          <button class="control-btn" id="expert-mic-btn" onclick="toggleMic('expert')" title="Toggle Microphone">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M9 3C7.89 3 7 3.89 7 5V9C7 10.11 7.89 11 9 11S11 10.11 11 9V5C11 3.89 10.11 3 9 3ZM12.5 9C12.5 11.33 10.83 13 8.5 13H7.5C5.17 13 3.5 11.33 3.5 9H2C2 11.76 4.24 14 7 14V16H9V14C11.76 14 14 11.76 14 9H12.5Z"/>
            </svg>
          </button>
          <button class="control-btn active" id="expert-camera-btn" onclick="toggleCamera('expert')" title="Toggle Camera">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M7 4V2C7 1.45 7.45 1 8 1H12C12.55 1 13 1.45 13 2V4H16C17.1 4 18 4.9 18 6V14C18 15.1 17.1 16 16 16H4C2.9 16 2 15.1 2 14V6C2 4.9 2.9 4 4 4H7ZM10 13C11.66 13 13 11.66 13 10S11.66 7 10 7 7 8.34 7 10 8.34 13 10 13Z"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="video-content">
        <video class="video-element" id="expert-video" autoplay muted playsinline></video>
        <div class="video-placeholder" id="expert-placeholder">
          <div class="placeholder-icon">
            <svg width="32" height="32" viewBox="0 0 20 20" fill="currentColor">
              <path d="M9 12C11.21 12 13 10.21 13 8S11.21 4 9 4 5 5.79 5 8 6.79 12 9 12ZM9 14C6.33 14 1 15.34 1 18V20H17V18C17 15.34 11.67 14 9 14Z"/>
            </svg>
          </div>
          <div class="placeholder-text">Expert Supervisor</div>
          <div class="placeholder-subtitle">Your video will appear here</div>
        </div>
      </div>
    </div>

    <!-- Resident Doctor Window (Top Right) -->
    <div class="video-window resident-window">
      <div class="window-header">
        <div class="window-title">
          <div class="status-indicator offline" id="resident-status"></div>
          Resident Doctor
        </div>
        <div class="window-controls">
          <button class="control-btn" title="Resident's audio status">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M9 3C7.89 3 7 3.89 7 5V9C7 10.11 7.89 11 9 11S11 10.11 11 9V5C11 3.89 10.11 3 9 3ZM12.5 9C12.5 11.33 10.83 13 8.5 13H7.5C5.17 13 3.5 11.33 3.5 9H2C2 11.76 4.24 14 7 14V16H9V14C11.76 14 14 11.76 14 9H12.5Z"/>
            </svg>
          </button>
          <button class="control-btn" title="Resident's video status">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M7 4V2C7 1.45 7.45 1 8 1H12C12.55 1 13 1.45 13 2V4H16C17.1 4 18 4.9 18 6V14C18 15.1 17.1 16 16 16H4C2.9 16 2 15.1 2 14V6C2 4.9 2.9 4 4 4H7ZM10 13C11.66 13 13 11.66 13 10S11.66 7 10 7 7 8.34 7 10 8.34 13 10 13Z"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="video-content">
        <video class="video-element" id="resident-video" autoplay playsinline style="display: none;"></video>
        <div class="video-placeholder" id="resident-placeholder">
          <div class="placeholder-icon">
            <svg width="32" height="32" viewBox="0 0 20 20" fill="currentColor">
              <path d="M9 12C11.21 12 13 10.21 13 8S11.21 4 9 4 5 5.79 5 8 6.79 12 9 12ZM9 14C6.33 14 1 15.34 1 18V20H17V18C17 15.34 11.67 14 9 14Z"/>
            </svg>
          </div>
          <div class="placeholder-text">Resident Doctor</div>
          <div class="placeholder-subtitle">Waiting for resident to join...</div>
        </div>
      </div>
    </div>

    <!-- Ultrasound Feed Window (Bottom Left) -->
    <div class="video-window ultrasound-window">
      <div class="window-header">
        <div class="window-title">
          <div class="status-indicator offline" id="ultrasound-status"></div>
          Ultrasound Feed
        </div>
        <div class="window-controls">
          <button class="control-btn" onclick="requestUltrasoundFeed()" title="Request ultrasound sharing">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M15 8C15 11.87 11.87 15 8 15S1 11.87 1 8 4.13 1 8 1C9.57 1 11.06 1.57 12.24 2.48L10.83 3.89C10.03 3.33 9.04 3 8 3C5.24 3 3 5.24 3 8S5.24 13 8 13 13 10.76 13 8H15ZM17 3V7H13V3H17Z"/>
            </svg>
          </button>
          <button class="control-btn" onclick="toggleUltrasoundFullscreen()" title="Toggle fullscreen">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M3 3H7V5H5V7H3V3ZM17 3V7H15V5H13V3H17ZM17 17H13V15H15V13H17V17ZM7 17V15H5V13H3V17H7Z"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="video-content">
        <video class="video-element" id="ultrasound-video" autoplay playsinline style="display: none;"></video>
        <div class="video-placeholder" id="ultrasound-placeholder">
          <div class="placeholder-icon">
            <svg width="32" height="32" viewBox="0 0 20 20" fill="currentColor">
              <path d="M3 3H17V7H15V5H5V7H3V3ZM17 17V13H15V15H5V13H3V17H17ZM9 8H11V12H9V8ZM7 9H5V11H7V9ZM15 9H13V11H15V9Z"/>
            </svg>
          </div>
          <div class="placeholder-text">Ultrasound Feed</div>
          <div class="placeholder-subtitle">Waiting for ultrasound sharing...</div>
        </div>
      </div>
    </div>

    <!-- Annotation Window (Bottom Right) -->
    <div class="video-window annotation-window">
      <div class="window-header">
        <div class="window-title">
          <div class="status-indicator"></div>
          ‚úèÔ∏è Annotation Tools
        </div>
        <div class="window-controls">
          <button class="control-btn" onclick="clearAnnotations()" title="Clear all annotations">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M8.5 11.5L10 13L11.5 11.5L13 13L14.5 11.5L16 13L17.5 11.5L19 13V3C19 1.9 18.1 1 17 1H3C1.9 1 1 1.9 1 3V13L2.5 11.5L4 13L5.5 11.5L7 13L8.5 11.5Z"/>
            </svg>
          </button>
          <button class="control-btn" onclick="saveAnnotations()" title="Save annotations">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M17 3H5C3.9 3 3 3.9 3 5V6H5V5H16V15.5L13.5 13H5V14H12.76L17 18.24V5C17 3.9 16.1 3 15 3H17ZM1 7V17C1 18.1 1.9 19 3 19H13L17 15H3V7H1Z"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="annotation-tools">
        <button class="tool-btn active" onclick="selectTool('pointer')" data-tool="pointer">Pointer</button>
        <button class="tool-btn" onclick="selectTool('pen')" data-tool="pen">Pen</button>
        <button class="tool-btn" onclick="selectTool('arrow')" data-tool="arrow">Arrow</button>
        <button class="tool-btn" onclick="selectTool('circle')" data-tool="circle">Circle</button>
        <button class="tool-btn" onclick="selectTool('text')" data-tool="text">Text</button>
        <button class="tool-btn" onclick="selectTool('measure')" data-tool="measure">Measure</button>
      </div>
      <div class="annotation-canvas">
        <div style="margin-bottom: 16px;">Annotation tools ready for ultrasound snapshots</div>
        
        <!-- Demo Controls (only visible in demo mode) -->
        <div id="demo-controls" style="display: none; border-top: 1px solid rgba(168, 85, 247, 0.3); padding-top: 16px;">
          <div style="color: #a855f7; font-size: 12px; font-weight: 600; margin-bottom: 8px;">üé≠ DEMO CONTROLS</div>
          
          <div style="margin-bottom: 12px;">
            <div style="font-size: 11px; color: #a855f7; opacity: 0.8; margin-bottom: 4px;">Resident Scenarios:</div>
            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
              <button onclick="updateResidentMock('normal')" style="font-size: 9px; padding: 2px 6px; background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: none; border-radius: 3px; cursor: pointer;">Normal</button>
              <button onclick="updateResidentMock('concerned')" style="font-size: 9px; padding: 2px 6px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: none; border-radius: 3px; cursor: pointer;">Emergency</button>
              <button onclick="updateResidentMock('learning')" style="font-size: 9px; padding: 2px 6px; background: rgba(16, 185, 129, 0.2); color: #10b981; border: none; border-radius: 3px; cursor: pointer;">Learning</button>
            </div>
          </div>
          
          <div>
            <div style="font-size: 11px; color: #a855f7; opacity: 0.8; margin-bottom: 4px;">Ultrasound Modes:</div>
            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
              <button onclick="updateUltrasoundMock('cardiac')" style="font-size: 9px; padding: 2px 6px; background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: none; border-radius: 3px; cursor: pointer;">Cardiac</button>
              <button onclick="updateUltrasoundMock('emergency')" style="font-size: 9px; padding: 2px 6px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: none; border-radius: 3px; cursor: pointer;">Emergency</button>
              <button onclick="updateUltrasoundMock('teaching')" style="font-size: 9px; padding: 2px 6px; background: rgba(168, 85, 247, 0.2); color: #a855f7; border: none; border-radius: 3px; cursor: pointer;">Teaching</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Meeting Controls -->
  <div class="meeting-controls">
    <button class="meeting-control-btn mic" id="main-mic-btn" onclick="toggleMainMic()" title="Toggle Microphone">
      <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
        <path d="M9 3C7.89 3 7 3.89 7 5V9C7 10.11 7.89 11 9 11S11 10.11 11 9V5C11 3.89 10.11 3 9 3ZM12.5 9C12.5 11.33 10.83 13 8.5 13H7.5C5.17 13 3.5 11.33 3.5 9H2C2 11.76 4.24 14 7 14V16H9V14C11.76 14 14 11.76 14 9H12.5Z"/>
      </svg>
    </button>
    
    <button class="meeting-control-btn camera" id="main-camera-btn" onclick="toggleMainCamera()" title="Toggle Camera">
      <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
        <path d="M7 4V2C7 1.45 7.45 1 8 1H12C12.55 1 13 1.45 13 2V4H16C17.1 4 18 4.9 18 6V14C18 15.1 17.1 16 16 16H4C2.9 16 2 15.1 2 14V6C2 4.9 2.9 4 4 4H7ZM10 13C11.66 13 13 11.66 13 10S11.66 7 10 7 7 8.34 7 10 8.34 13 10 13Z"/>
      </svg>
    </button>
    
    <button class="meeting-control-btn screen-share" id="screen-share-btn" onclick="toggleScreenShare()" title="Share Screen">
      <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
        <path d="M2 4V16H6V14H4V6H16V14H14V16H18V4H2ZM11 8V12H13L10 15L7 12H9V8H11Z"/>
      </svg>
    </button>
    
    <button class="meeting-control-btn end-call" onclick="endCall()" title="End Call">
      <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
        <path d="M6.62 10.79C7.56 12.59 9.41 14.44 11.21 15.38L12.41 14.18C12.61 13.98 12.86 13.92 13.1 13.99C13.75 14.18 14.44 14.27 15.15 14.27C15.44 14.27 15.68 14.51 15.68 14.8V17.62C15.68 17.91 15.44 18.15 15.15 18.15C8.43 18.15 3 12.72 3 6C3 5.71 3.24 5.47 3.53 5.47H6.35C6.64 5.47 6.88 5.71 6.88 6C6.88 6.71 6.97 7.4 7.16 8.05C7.23 8.29 7.17 8.54 6.97 8.74L5.77 9.94L6.62 10.79Z"/>
      </svg>
    </button>
  </div>

  <!-- Load Scripts -->
  <script src="../js/simple-auth-fixed.js"></script>
  <script src="../js/enhanced-meeting-manager.js"></script>

  <script>
    // Multi-window video call functionality
    let webex = null;
    let currentMeeting = null;
    let localVideoStream = null;
    let isAudioEnabled = true;
    let isVideoEnabled = true;
    let isScreenSharing = false;
    let meetingStartTime = null;
    let timerInterval = null;
    let participantCount = 1;

    // Initialize video call on page load
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Multi-window video call initializing...');
      
      try {
        await initializeVideoCall();
      } catch (error) {
        console.error('‚ùå Failed to initialize video call:', error);
        showError('Failed to initialize video call: ' + error.message);
      }
      
      // Set up keyboard shortcuts
      setupKeyboardShortcuts();
    });
    
    // Set up keyboard shortcuts for call controls
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(event) {
        // Don't trigger shortcuts if user is typing in an input
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
          return;
        }
        
        switch (event.code) {
          case 'Escape':
            // ESC key to end call
            event.preventDefault();
            confirmEndCall();
            break;
          case 'KeyQ':
            // Ctrl+Q or Cmd+Q to end call
            if (event.ctrlKey || event.metaKey) {
              event.preventDefault();
              confirmEndCall();
            }
            break;
          case 'KeyM':
            // M key to toggle microphone
            event.preventDefault();
            toggleMic('expert');
            break;
          case 'KeyV':
            // V key to toggle video/camera
            event.preventDefault();
            toggleCamera('expert');
            break;
        }
      });
      
      console.log('‚å®Ô∏è Keyboard shortcuts enabled:');
      console.log('   ESC or Ctrl+Q: End call');
      console.log('   M: Toggle microphone');
      console.log('   V: Toggle camera');
    }
    
    // Confirm end call with better UX
    function confirmEndCall() {
      const endCallBtn = document.querySelector('.meeting-control-btn.end-call');
      if (endCallBtn) {
        // Add visual feedback
        endCallBtn.style.transform = 'scale(0.95)';
        endCallBtn.style.background = 'rgba(239, 68, 68, 0.8)';
        
        setTimeout(() => {
          endCallBtn.style.transform = '';
          endCallBtn.style.background = '';
          endCall();
        }, 150);
      } else {
        endCall();
      }
    }
    
    // Clean up resources when page is unloaded
    window.addEventListener('beforeunload', function(event) {
      console.log('üßπ Page unloading - cleaning up resources...');
      
      // Stop all media streams
      if (localVideoStream) {
        localVideoStream.getTracks().forEach(track => {
          track.stop();
          console.log(`üõë Cleanup: Stopped ${track.kind} track`);
        });
      }
      
      // Leave meeting if active
      if (currentMeeting) {
        try {
          currentMeeting.leave();
          console.log('üõë Cleanup: Left meeting');
        } catch (error) {
          console.error('‚ùå Cleanup error:', error);
        }
      }
      
      // Stop timer
      if (timerInterval) {
        clearInterval(timerInterval);
      }
    });
    
    // Also handle visibility change (tab switching)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        console.log('Tab hidden - pausing non-essential activities');
      } else {
        console.log('Tab visible - resuming activities');
      }
    });

    // Initialize video call system
    async function initializeVideoCall() {
      // Parse URL parameters
      const params = new URLSearchParams(window.location.search);
      const meetingId = params.get('meetingId');
      const meetingNumber = params.get('meetingNumber');
      const sipUri = params.get('sipUri');
      const isHost = params.get('isHost') === 'true';

      // Display meeting info
      document.getElementById('meeting-id-display').textContent = meetingNumber || meetingId || 'Demo Meeting';

      // Check authentication
      if (!isAuthenticated()) {
        throw new Error('User not authenticated');
      }

      const token = getAccessToken();

      // Initialize Webex SDK
      if (typeof Webex !== 'undefined' && !token.startsWith('demo_token_')) {
        console.log('Initializing real Webex SDK...');
        webex = new Webex({
          credentials: { access_token: token }
        });
        
        await webex.meetings.register();
        console.log('‚úÖ Webex SDK registered');

        // Join the meeting if we have connection details
        if (sipUri || meetingId) {
          await joinMeeting(sipUri || meetingId);
        }
      } else {
        console.log('üé≠ Running in demo mode...');
        await initializeDemoMode();
      }

      // Start local video immediately (Expert Supervisor window)
      await startLocalVideo();

      // Start meeting timer
      startMeetingTimer();

      // Simulate some activity for demo
      setTimeout(() => simulateResidentJoin(), 3000);
      setTimeout(() => simulateUltrasoundFeed(), 8000);
      
      // Add mock content cycling (for development/demo purposes)
      if (localStorage.getItem('webex_access_token')?.startsWith('demo_token_')) {
        setTimeout(() => setupMockContentCycling(), 12000);
      }
    }

    // Join Webex meeting
    async function joinMeeting(destination) {
      try {
        console.log('üîó Joining meeting:', destination);
        
        const meeting = await webex.meetings.create(destination);
        await meeting.join();
        
        currentMeeting = meeting;
        
        // Set up meeting events
        setupMeetingEvents(meeting);
        
        console.log('‚úÖ Successfully joined meeting');
        
      } catch (error) {
        console.error('‚ùå Failed to join meeting:', error);
        throw error;
      }
    }

    // Set up meeting event listeners
    function setupMeetingEvents(meeting) {
      meeting.on('media:ready', (media) => {
        console.log('Media ready:', media.type);
        handleMediaReady(media);
      });

      meeting.on('meeting:stateChanged', (event) => {
        console.log('Meeting state changed:', event.currentState);
      });

      meeting.on('member:added', (participant) => {
        console.log('Participant joined:', participant.identity);
        participantCount++;
        updateParticipantCount();
      });

      meeting.on('member:removed', (participant) => {
        console.log('üëã Participant left:', participant.identity);
        participantCount = Math.max(1, participantCount - 1);
        updateParticipantCount();
      });
    }

    // Handle media ready events
    function handleMediaReady(media) {
      if (media.type === 'localVideo') {
        const videoElement = document.getElementById('expert-video');
        videoElement.srcObject = media.stream;
        videoElement.style.display = 'block';
        document.getElementById('expert-placeholder').style.display = 'none';
        document.getElementById('expert-status').className = 'status-indicator';
      } else if (media.type === 'remoteVideo') {
        // Handle remote participant video
        const videoElement = document.getElementById('resident-video');
        videoElement.srcObject = media.stream;
        videoElement.style.display = 'block';
        document.getElementById('resident-placeholder').style.display = 'none';
        document.getElementById('resident-status').className = 'status-indicator';
      }
    }

    // Start local video for expert supervisor
    async function startLocalVideo() {
      try {
        console.log('Starting local video...');
        
        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Camera API not supported in this browser');
        }
        
        // First check available devices
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        console.log(`Found ${videoDevices.length} video devices`);
        
        if (videoDevices.length === 0) {
          throw new Error('No camera devices found');
        }
        
        // Enhanced constraints with fallback options
        const constraints = {
          video: { 
            width: { ideal: 1280, min: 640 }, 
            height: { ideal: 720, min: 480 },
            facingMode: 'user',
            frameRate: { ideal: 30, min: 15 }
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true
          }
        };
        
        console.log('Requesting camera access with constraints:', constraints);
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        if (!stream || stream.getVideoTracks().length === 0) {
          throw new Error('No video tracks in stream');
        }
        
        localVideoStream = stream;
        
        // Display in expert supervisor window
        const videoElement = document.getElementById('expert-video');
        const placeholder = document.getElementById('expert-placeholder');
        const statusIndicator = document.getElementById('expert-status');
        
        if (!videoElement) {
          throw new Error('Expert video element not found');
        }
        
        // Set up video element
        videoElement.srcObject = stream;
        videoElement.muted = true; // Prevent audio feedback
        videoElement.style.display = 'block';
        
        // Wait for video to start playing
        await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            reject(new Error('Video playback timeout'));
          }, 10000);
          
          videoElement.onloadedmetadata = () => {
            clearTimeout(timeout);
            console.log(`Video metadata loaded: ${videoElement.videoWidth}x${videoElement.videoHeight}`);
            resolve();
          };
          
          videoElement.onerror = () => {
            clearTimeout(timeout);
            reject(new Error('Video element error'));
          };
        });
        
        // Hide placeholder and update status
        if (placeholder) {
          placeholder.style.display = 'none';
        }
        if (statusIndicator) {
          statusIndicator.className = 'status-indicator connected';
        }
        
        // Log stream details
        const videoTrack = stream.getVideoTracks()[0];
        const settings = videoTrack.getSettings();
        console.log('‚úÖ Local video started successfully');
        console.log(`Video track: ${videoTrack.label}`);
        console.log(`Resolution: ${settings.width}x${settings.height} @ ${settings.frameRate}fps`);
        
        // Auto-enable camera button
        const cameraBtn = document.getElementById('expert-camera-btn');
        if (cameraBtn) {
          cameraBtn.classList.add('active');
        }
        
        // Set up track event listeners
        videoTrack.addEventListener('ended', () => {
          console.log('‚ö†Ô∏è Video track ended');
          handleCameraLost();
        });
        
      } catch (error) {
        console.error('‚ùå Failed to start local video:', error);
        handleCameraError(error);
      }
    }
    
    // Handle camera initialization errors
    function handleCameraError(error) {
      const placeholder = document.getElementById('expert-placeholder');
      const statusIndicator = document.getElementById('expert-status');
      const cameraBtn = document.getElementById('expert-camera-btn');
      
      let errorMessage = 'Camera Error';
      let errorDetails = 'Please check your camera';
      let errorIcon = '‚ö†Ô∏è';
      
      // Specific error handling
      switch (error.name) {
        case 'NotAllowedError':
          errorMessage = 'Camera Access Denied';
          errorDetails = 'Please allow camera permissions and refresh';
          errorIcon = 'üö´';
          break;
        case 'NotFoundError':
          errorMessage = 'No Camera Found';
          errorDetails = 'Please connect a camera device';
          errorIcon = 'CAM';
          break;
        case 'NotReadableError':
          errorMessage = 'Camera In Use';
          errorDetails = 'Camera is being used by another app';
          errorIcon = 'üîí';
          break;
        case 'OverconstrainedError':
          errorMessage = 'Camera Constraints Error';
          errorDetails = 'Your camera doesn\'t support the required settings';
          errorIcon = '‚öôÔ∏è';
          break;
        case 'SecurityError':
          errorMessage = 'Security Error';
          errorDetails = 'Camera access blocked by security policy';
          errorIcon = 'üîê';
          break;
        default:
          errorMessage = 'Camera Error';
          errorDetails = error.message || 'Unknown camera error';
          break;
      }
      
      // Update UI
      if (placeholder) {
        placeholder.style.display = 'flex';
        placeholder.innerHTML = `
          <div class="placeholder-icon">${errorIcon}</div>
          <div class="placeholder-text">${errorMessage}</div>
          <div class="placeholder-subtitle">${errorDetails}</div>
          <button style="margin-top: 10px; padding: 8px 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="retryCamera()">
            üîÑ Retry Camera
          </button>
        `;
      }
      
      if (statusIndicator) {
        statusIndicator.className = 'status-indicator error';
      }
      
      if (cameraBtn) {
        cameraBtn.classList.remove('active');
        cameraBtn.classList.add('disabled');
      }
    }
    
    // Handle camera disconnection
    function handleCameraLost() {
      console.log('Camera connection lost');
      const placeholder = document.getElementById('expert-placeholder');
      const statusIndicator = document.getElementById('expert-status');
      
      if (placeholder) {
        placeholder.style.display = 'flex';
        placeholder.innerHTML = `
          <div class="placeholder-icon">CAM</div>
          <div class="placeholder-text">Camera Disconnected</div>
          <div class="placeholder-subtitle">Camera was disconnected</div>
          <button style="margin-top: 10px; padding: 8px 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="retryCamera()">
            üîÑ Reconnect
          </button>
        `;
      }
      
      if (statusIndicator) {
        statusIndicator.className = 'status-indicator disconnected';
      }
    }
    
    // Retry camera initialization
    async function retryCamera() {
      console.log('üîÑ Retrying camera initialization...');
      const placeholder = document.getElementById('expert-placeholder');
      
      if (placeholder) {
        placeholder.innerHTML = `
          <div class="placeholder-icon">
            <div style="width: 32px; height: 32px; border: 3px solid #007acc; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          </div>
          <div class="placeholder-text">Connecting Camera...</div>
          <div class="placeholder-subtitle">Please wait</div>
        `;
      }
      
      // Clean up existing stream
      if (localVideoStream) {
        localVideoStream.getTracks().forEach(track => track.stop());
        localVideoStream = null;
      }
      
      // Wait a moment then retry
      setTimeout(() => {
        startLocalVideo();
      }, 1000);
    }

    // Initialize demo mode
    async function initializeDemoMode() {
      console.log('üé≠ Initializing demo mode...');
      
      // Show demo controls in annotation window
      const demoControls = document.getElementById('demo-controls');
      if (demoControls) {
        demoControls.style.display = 'block';
        console.log('‚úÖ Demo controls enabled');
      }
      
      // Simulate some demo behavior
      setTimeout(() => {
        console.log('üé≠ Demo: Simulating successful connection');
      }, 1000);
    }

    // Simulate resident joining with mock video feed
    function simulateResidentJoin() {
      console.log('üé≠ Demo: Resident joining...');
      
      const residentStatus = document.getElementById('resident-status');
      const residentPlaceholder = document.getElementById('resident-placeholder');
      const residentVideo = document.getElementById('resident-video');
      
      residentStatus.className = 'status-indicator connecting';
      residentPlaceholder.innerHTML = `
        <div class="placeholder-icon">
          <div style="width: 32px; height: 32px; border: 3px solid #f59e0b; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>
        <div class="placeholder-text">Resident Doctor</div>
        <div class="placeholder-subtitle">Connecting...</div>
      `;
      
      setTimeout(() => {
        residentStatus.className = 'status-indicator connected';
        
        // Create mock video element with placeholder image
        const mockVideoContainer = document.createElement('div');
        mockVideoContainer.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 1;
        `;
        
        // Create mock doctor avatar
        const avatarContainer = document.createElement('div');
        avatarContainer.style.cssText = `
          width: 120px;
          height: 120px;
          border-radius: 50%;
          background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 48px;
          color: white;
          margin-bottom: 16px;
          border: 3px solid rgba(255, 255, 255, 0.3);
          box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
          animation: breathe 4s ease-in-out infinite;
        `;
        avatarContainer.textContent = 'DR';
        
        // Add doctor name and status
        const doctorInfo = document.createElement('div');
        doctorInfo.style.cssText = `
          text-align: center;
          color: white;
        `;
        doctorInfo.innerHTML = `
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">Dr. Sarah Johnson</div>
          <div style="font-size: 14px; opacity: 0.9;">Resident Doctor</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 8px;">Emergency Room</div>
        `;
        
        // Add subtle animation
        mockVideoContainer.style.animation = 'fadeIn 0.5s ease-in';
        
        mockVideoContainer.appendChild(avatarContainer);
        mockVideoContainer.appendChild(doctorInfo);
        
        // Add to video content area
        const videoContent = residentPlaceholder.parentElement;
        videoContent.appendChild(mockVideoContainer);
        
        // Hide placeholder
        residentPlaceholder.style.display = 'none';
        
        participantCount = 2;
        updateParticipantCount();
        
        console.log('‚úÖ Mock resident video feed active');
      }, 2000);
    }

    // Simulate ultrasound feed with mock medical imagery
    function simulateUltrasoundFeed() {
      console.log('üé≠ Demo: Ultrasound feed starting...');
      
      const ultrasoundStatus = document.getElementById('ultrasound-status');
      const ultrasoundPlaceholder = document.getElementById('ultrasound-placeholder');
      
      ultrasoundStatus.className = 'status-indicator connecting';
      ultrasoundPlaceholder.innerHTML = `
        <div class="placeholder-icon">
          <div style="width: 32px; height: 32px; border: 3px solid #f59e0b; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>
        <div class="placeholder-text">Ultrasound Feed</div>
        <div class="placeholder-subtitle">Connecting to device...</div>
      `;
      
      setTimeout(() => {
        ultrasoundStatus.className = 'status-indicator connected';
        
        // Create mock ultrasound display
        const mockUltrasoundContainer = document.createElement('div');
        mockUltrasoundContainer.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 1;
        `;
        
        // Create mock ultrasound screen
        const ultrasoundScreen = document.createElement('div');
        ultrasoundScreen.style.cssText = `
          width: 80%;
          height: 70%;
          background: radial-gradient(ellipse at center, #1f2937 0%, #111827 100%);
          border: 2px solid #374151;
          border-radius: 8px;
          position: relative;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        `;
        
        // Add mock ultrasound image pattern
        const ultrasoundPattern = document.createElement('div');
        ultrasoundPattern.style.cssText = `
          width: 90%;
          height: 90%;
          background: radial-gradient(circle at 60% 40%, rgba(245, 158, 11, 0.3) 0%, transparent 50%),
                      radial-gradient(circle at 30% 70%, rgba(59, 130, 246, 0.2) 0%, transparent 40%),
                      linear-gradient(45deg, rgba(16, 185, 129, 0.1) 25%, transparent 25%),
                      #0f172a;
          border-radius: 4px;
          position: relative;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        
        // Add scan lines effect
        const scanLines = document.createElement('div');
        scanLines.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: repeating-linear-gradient(
            0deg,
            transparent,
            transparent 2px,
            rgba(245, 158, 11, 0.1) 2px,
            rgba(245, 158, 11, 0.1) 4px
          );
          animation: scanLine 2s linear infinite;
        `;
        
        // Add ultrasound readings overlay
        const readingsOverlay = document.createElement('div');
        readingsOverlay.style.cssText = `
          position: absolute;
          top: 10px;
          left: 10px;
          color: #f59e0b;
          font-family: monospace;
          font-size: 11px;
          line-height: 1.4;
        `;
        readingsOverlay.innerHTML = `
          <div>DEPTH: 8.2cm</div>
          <div>FREQ: 5.0MHz</div>
          <div>GAIN: 65%</div>
          <div>TI: 0.1</div>
        `;
        
        // Device info
        const deviceInfo = document.createElement('div');
        deviceInfo.style.cssText = `
          margin-top: 16px;
          text-align: center;
          color: #f59e0b;
          font-size: 12px;
        `;
        deviceInfo.innerHTML = `
          <div style="font-weight: 600;">GE Healthcare Vivid E95</div>
          <div style="opacity: 0.8; margin-top: 4px;">Live Feed Active</div>
        `;
        
        ultrasoundPattern.appendChild(scanLines);
        ultrasoundPattern.appendChild(readingsOverlay);
        ultrasoundScreen.appendChild(ultrasoundPattern);
        mockUltrasoundContainer.appendChild(ultrasoundScreen);
        mockUltrasoundContainer.appendChild(deviceInfo);
        
        // Add to video content area
        const videoContent = ultrasoundPlaceholder.parentElement;
        videoContent.appendChild(mockUltrasoundContainer);
        
        // Hide placeholder
        ultrasoundPlaceholder.style.display = 'none';
        
        console.log('‚úÖ Mock ultrasound feed active');
      }, 3000);
    }
    
    // Setup mock content cycling for demo purposes
    function setupMockContentCycling() {
      console.log('üé≠ Setting up mock content cycling...');
      
      let cycleCount = 0;
      const mockScenarios = [
        {
          name: 'Normal Examination',
          residentAction: () => updateResidentMock('normal'),
          ultrasoundAction: () => updateUltrasoundMock('cardiac')
        },
        {
          name: 'Emergency Case',
          residentAction: () => updateResidentMock('concerned'),
          ultrasoundAction: () => updateUltrasoundMock('emergency')
        },
        {
          name: 'Teaching Session',
          residentAction: () => updateResidentMock('learning'),
          ultrasoundAction: () => updateUltrasoundMock('teaching')
        }
      ];
      
      // Cycle through scenarios every 30 seconds
      setInterval(() => {
        if (cycleCount < mockScenarios.length) {
          const scenario = mockScenarios[cycleCount];
          console.log(`üé≠ Switching to scenario: ${scenario.name}`);
          
          scenario.residentAction();
          setTimeout(scenario.ultrasoundAction, 2000);
          
          cycleCount = (cycleCount + 1) % mockScenarios.length;
        }
      }, 30000);
    }
    
    // Update resident mock with different scenarios
    function updateResidentMock(scenario) {
      const residentVideo = document.querySelector('.resident-window .video-content > div:last-child');
      if (!residentVideo) return;
      
      const scenarios = {
        normal: {
          avatar: 'DR',
          name: 'Dr. Sarah Johnson',
          status: 'Conducting examination',
          location: 'Room 302',
          color: '#3b82f6'
        },
        concerned: {
          avatar: 'DR',
          name: 'Dr. Michael Chen',
          status: 'Emergency consultation',
          location: 'ER - Trauma Bay 1',
          color: '#ef4444'
        },
        learning: {
          avatar: 'ST',
          name: 'Dr. Emma Rodriguez',
          status: 'Training session',
          location: 'Simulation Lab',
          color: '#10b981'
        }
      };
      
      const config = scenarios[scenario];
      residentVideo.style.background = `linear-gradient(135deg, ${config.color}20 0%, ${config.color}40 100%)`;
      
      const avatar = residentVideo.querySelector('div:first-child');
      const info = residentVideo.querySelector('div:last-child');
      
      if (avatar) avatar.textContent = config.avatar;
      if (info) {
        info.innerHTML = `
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${config.name}</div>
          <div style="font-size: 14px; opacity: 0.9;">${config.status}</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 8px;">üìç ${config.location}</div>
        `;
      }
    }
    
    // Update ultrasound mock with different scenarios  
    function updateUltrasoundMock(scenario) {
      const ultrasoundContainer = document.querySelector('.ultrasound-window .video-content > div:last-child');
      if (!ultrasoundContainer) return;
      
      const screen = ultrasoundContainer.querySelector('div:first-child div:first-child');
      const info = ultrasoundContainer.querySelector('div:last-child');
      
      const scenarios = {
        cardiac: {
          pattern: `radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.4) 0%, transparent 60%),
                   radial-gradient(circle at 70% 30%, rgba(59, 130, 246, 0.3) 0%, transparent 40%),
                   #0f172a`,
          readings: `
            <div>DEPTH: 12.4cm</div>
            <div>FREQ: 3.5MHz</div>
            <div>GAIN: 72%</div>
            <div>HR: 78 BPM</div>
          `,
          device: 'Cardiac Scan - Normal Rhythm'
        },
        emergency: {
          pattern: `radial-gradient(circle at 40% 60%, rgba(239, 68, 68, 0.4) 0%, transparent 50%),
                   radial-gradient(circle at 80% 20%, rgba(245, 158, 11, 0.3) 0%, transparent 40%),
                   #0f172a`,
          readings: `
            <div>DEPTH: 15.2cm</div>
            <div>FREQ: 2.5MHz</div>
            <div>GAIN: 85%</div>
            <div>‚ö†Ô∏è ALERT</div>
          `,
          device: 'Emergency Scan - Trauma Assessment'
        },
        teaching: {
          pattern: `radial-gradient(circle at 30% 40%, rgba(16, 185, 129, 0.4) 0%, transparent 50%),
                   radial-gradient(circle at 60% 70%, rgba(168, 85, 247, 0.3) 0%, transparent 40%),
                   #0f172a`,
          readings: `
            <div>DEPTH: 8.8cm</div>
            <div>FREQ: 7.5MHz</div>
            <div>GAIN: 65%</div>
            <div>üìö DEMO MODE</div>
          `,
          device: 'Teaching Mode - Educational Content'
        }
      };
      
      const config = scenarios[scenario];
      if (screen) {
        screen.style.background = config.pattern;
        const readings = screen.querySelector('div:last-child');
        if (readings) readings.innerHTML = config.readings;
      }
      
      if (info) {
        info.innerHTML = `
          <div style="font-weight: 600;">${config.device}</div>
          <div style="opacity: 0.8; margin-top: 4px;">Live Feed Active</div>
        `;
      }
    }

    // Meeting timer
    function startMeetingTimer() {
      meetingStartTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
      if (!meetingStartTime) return;
      
      const elapsed = Date.now() - meetingStartTime;
      const hours = Math.floor(elapsed / 3600000);
      const minutes = Math.floor((elapsed % 3600000) / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      
      const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('meeting-timer').textContent = timeString;
    }

    // Update participant count
    function updateParticipantCount() {
      const countText = participantCount === 1 ? '1 participant' : `${participantCount} participants`;
      document.getElementById('participants-count').textContent = countText;
    }

    // Control functions
    function toggleMainMic() {
      isAudioEnabled = !isAudioEnabled;
      const btn = document.getElementById('main-mic-btn');
      
      if (isAudioEnabled) {
        btn.classList.remove('muted');
        if (localVideoStream) {
          localVideoStream.getAudioTracks().forEach(track => track.enabled = true);
        }
      } else {
        btn.classList.add('muted');
        if (localVideoStream) {
          localVideoStream.getAudioTracks().forEach(track => track.enabled = false);
        }
      }
      
      console.log('üé§ Audio', isAudioEnabled ? 'enabled' : 'muted');
    }

    function toggleMainCamera() {
      isVideoEnabled = !isVideoEnabled;
      const btn = document.getElementById('main-camera-btn');
      const videoElement = document.getElementById('expert-video');
      const placeholder = document.getElementById('expert-placeholder');
      
      if (isVideoEnabled) {
        btn.classList.remove('disabled');
        if (localVideoStream) {
          localVideoStream.getVideoTracks().forEach(track => track.enabled = true);
          videoElement.style.display = 'block';
          placeholder.style.display = 'none';
        }
      } else {
        btn.classList.add('disabled');
        if (localVideoStream) {
          localVideoStream.getVideoTracks().forEach(track => track.enabled = false);
          videoElement.style.display = 'none';
          placeholder.style.display = 'flex';
          placeholder.innerHTML = `
            <div class="placeholder-icon">CAM</div>
            <div class="placeholder-text">Camera Off</div>
            <div class="placeholder-subtitle">Click to turn on camera</div>
          `;
        }
      }
      
      console.log('Video', isVideoEnabled ? 'enabled' : 'disabled');
    }

    function toggleScreenShare() {
      isScreenSharing = !isScreenSharing;
      const btn = document.getElementById('screen-share-btn');
      
      if (isScreenSharing) {
        btn.classList.add('active');
        console.log('üñ•Ô∏è Screen sharing started');
        // Here you would implement actual screen sharing
      } else {
        btn.classList.remove('active');
        console.log('üñ•Ô∏è Screen sharing stopped');
      }
    }

    function endCall() {
      // Get meeting duration for the confirmation dialog
      const meetingTimeElement = document.getElementById('meeting-time');
      const currentDuration = meetingTimeElement ? meetingTimeElement.textContent : '00:00';
      
      // Create a more informative confirmation
      const confirmMessage = `Are you sure you want to end this video call?

Meeting Duration: ${currentDuration}
This will disconnect all participants and cannot be undone.

Click OK to end the call and return to the homepage.`;

      if (confirm(confirmMessage)) {
        console.log('Ending call...');
        
        // Show ending state visually
        showCallEndingState();
        
        // Stop local streams
        if (localVideoStream) {
          localVideoStream.getTracks().forEach(track => {
            track.stop();
            console.log(`üõë Stopped ${track.kind} track: ${track.label}`);
          });
          localVideoStream = null;
        }
        
        // Leave meeting
        if (currentMeeting) {
          try {
            currentMeeting.leave();
            console.log('‚úÖ Left Webex meeting');
          } catch (error) {
            console.error('‚ùå Error leaving meeting:', error);
          }
          currentMeeting = null;
        }
        
        // Stop timer
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
          console.log('üõë Meeting timer stopped');
        }
        
        // Clean up any other resources
        if (webex) {
          try {
            // Clean up Webex SDK resources
            console.log('üßπ Cleaning up Webex resources...');
          } catch (error) {
            console.error('‚ùå Error cleaning up Webex:', error);
          }
        }
        
        console.log('‚úÖ Call ended successfully');
        
        // Navigate back to home with proper path resolution
        setTimeout(() => {
          navigateToHome();
        }, 1000); // Small delay to show ending state
      }
    }
    
    // Show visual feedback when ending call
    function showCallEndingState() {
      // Update all status indicators to show disconnecting
      const statusIndicators = document.querySelectorAll('.status-indicator');
      statusIndicators.forEach(indicator => {
        indicator.className = 'status-indicator offline';
      });
      
      // Update video placeholders
      const placeholders = document.querySelectorAll('.video-placeholder');
      placeholders.forEach(placeholder => {
        placeholder.style.display = 'flex';
        placeholder.innerHTML = `
          <div class="placeholder-icon">
            <div style="width: 32px; height: 32px; border: 3px solid #ef4444; border-top: 3px solid transparent; border-radius: 50%; animation: spin 2s linear infinite;"></div>
          </div>
          <div class="placeholder-text">Ending Call...</div>
          <div class="placeholder-subtitle">Disconnecting</div>
        `;
      });
      
      // Hide video elements
      const videoElements = document.querySelectorAll('.video-element');
      videoElements.forEach(video => {
        video.style.display = 'none';
      });
      
      // Update meeting timer
      const meetingTime = document.getElementById('meeting-time');
      if (meetingTime) {
        meetingTime.style.color = '#ef4444';
        meetingTime.textContent = 'Call Ended';
      }
      
      // Disable all control buttons
      const controlButtons = document.querySelectorAll('.control-btn, .meeting-control-btn');
      controlButtons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      });
    }
    
    // Navigate to homepage with proper path resolution
    function navigateToHome() {
      try {
        console.log('üè† Navigating to homepage...');
        
        // Get current path for debugging
        const currentPath = window.location.pathname;
        const currentOrigin = window.location.origin;
        
        console.log('üìç Current location:', currentOrigin + currentPath);
        
        // Calculate the proper path to homepage
        let homePath;
        
        if (currentPath.includes('/src/pages/')) {
          // We're in the pages directory, go up to get to home-clean.html
          const basePath = currentPath.substring(0, currentPath.indexOf('/src/pages/'));
          homePath = basePath + '/src/pages/home-clean.html';
        } else if (currentPath.includes('/pages/')) {
          // Alternative path structure
          const basePath = currentPath.substring(0, currentPath.indexOf('/pages/'));
          homePath = basePath + '/pages/home-clean.html';
        } else {
          // Default fallback - try relative path
          homePath = 'home-clean.html';
        }
        
        // Clean up any double slashes
        homePath = homePath.replace(/\/+/g, '/');
        
        console.log('Navigating to:', homePath);
        
        // Try navigation
        window.location.href = homePath;
        
      } catch (error) {
        console.error('‚ùå Navigation error:', error);
        
        // Fallback navigation attempts
        console.log('üîÑ Trying fallback navigation...');
        
        // Try different path variations
        const fallbackPaths = [
          'home-clean.html',
          '../home-clean.html',
          '/src/pages/home-clean.html',
          './home-clean.html'
        ];
        
        // Use the first fallback for now
        try {
          window.location.href = fallbackPaths[0];
        } catch (fallbackError) {
          console.error('‚ùå Fallback navigation failed:', fallbackError);
          
          // Last resort - show user manual navigation
          alert(`
Call ended successfully! 

Please manually navigate back to the homepage if you are not redirected automatically.

Click OK to try refreshing the page.`);
          
          // Try to reload the page to reset state
          window.location.reload();
        }
      }
    }

    // Individual window controls
    function toggleMic(window) {
      console.log(`üé§ Toggling mic for ${window} window`);
    }

    function toggleCamera(window) {
      console.log(`Toggling camera for ${window} window`);
      
      if (window === 'expert' && localVideoStream) {
        const videoTrack = localVideoStream.getVideoTracks()[0];
        const cameraBtn = document.getElementById('expert-camera-btn');
        const videoElement = document.getElementById('expert-video');
        const placeholder = document.getElementById('expert-placeholder');
        
        if (videoTrack) {
          const isEnabled = videoTrack.enabled;
          videoTrack.enabled = !isEnabled;
          
          // Update UI
          if (cameraBtn) {
            if (videoTrack.enabled) {
              cameraBtn.classList.add('active');
              cameraBtn.classList.remove('disabled');
              if (videoElement) videoElement.style.display = 'block';
              if (placeholder) placeholder.style.display = 'none';
              console.log('Camera enabled');
            } else {
              cameraBtn.classList.remove('active');
              cameraBtn.classList.add('disabled');
              if (videoElement) videoElement.style.display = 'none';
              if (placeholder) {
                placeholder.style.display = 'flex';
                placeholder.innerHTML = `
                  <div class="placeholder-icon">CAM</div>
                  <div class="placeholder-text">Camera Off</div>
                  <div class="placeholder-subtitle">Camera is disabled</div>
                `;
              }
              console.log('Camera disabled');
            }
          }
        } else {
          console.log('‚ö†Ô∏è No video track available for camera toggle');
          // Try to restart camera if no track exists
          retryCamera();
        }
      } else {
        console.log(`‚ö†Ô∏è Toggle camera not implemented for ${window} window`);
      }
    }

    // Ultrasound controls
    function requestUltrasoundFeed() {
      console.log('Requesting ultrasound feed...');
      showToast('Ultrasound sharing request sent');
    }

    function toggleUltrasoundFullscreen() {
      console.log('üñ•Ô∏è Toggling ultrasound fullscreen...');
    }

    // Annotation tools
    let selectedTool = 'pointer';

    function selectTool(tool) {
      selectedTool = tool;
      
      // Update UI
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
      
      console.log(`‚úèÔ∏è Selected tool: ${tool}`);
    }

    function clearAnnotations() {
      console.log('üóëÔ∏è Clearing annotations...');
      showToast('üóëÔ∏è Annotations cleared');
    }

    function saveAnnotations() {
      console.log('üíæ Saving annotations...');
      showToast('üíæ Annotations saved');
    }

    // Toast notification function
    function showToast(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        z-index: 10001;
        animation: slideInRight 0.3s ease-out;
      `;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideInRight 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Error handling
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(239, 68, 68, 0.95);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        z-index: 10002;
        max-width: 400px;
      `;
      errorDiv.innerHTML = `
        <h3>‚ùå Error</h3>
        <p style="margin: 1rem 0; line-height: 1.5;">${message}</p>
        <button onclick="this.parentElement.remove(); window.location.href='home-clean.html';" 
                style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
          Return to Home
        </button>
      `;
      
      document.body.appendChild(errorDiv);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 'm':
            e.preventDefault();
            toggleMainMic();
            break;
          case 'v':
            e.preventDefault();
            toggleMainCamera();
            break;
          case 's':
            e.preventDefault();
            toggleScreenShare();
            break;
        }
      }
      
      // Escape to end call
      if (e.key === 'Escape') {
        endCall();
      }
    });

    console.log('‚úÖ Multi-window video call system ready');
  </script>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</body>
</html>
