<!DOCTYPE html>
<!-- CSS and HTML styling assisted by GitHub Copilot extension -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home - Neurotate Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Chart.js library for data visualization - https://www.chartjs.org/ -->
  <script src="../../node_modules/chart.js/dist/chart.umd.js"></script>
  <script src="../js/statistics-manager.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
      color: #e2e8f0;
      min-height: 100vh;
    }

    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }

    .sidebar-header {
      padding: 2rem 1.5rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo h2 {
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'Orbitron', 'Inter', sans-serif;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .sidebar-menu {
      flex: 1;
      padding: 1rem 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1.5rem;
      color: #94a3b8;
      text-decoration: none;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #e2e8f0;
    }

    .nav-item.active {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border-left-color: #3b82f6;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 2rem;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      color: #94a3b8;
      font-size: 1.1rem;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
      color: #e2e8f0;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    .action-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
      transform: translateY(-2px);
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      border-color: transparent;
      color: white;
    }

    .action-btn.primary:hover {
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    /* Charts Section */
    .charts-section {
      margin-top: 2rem;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 16px;
      padding: 2rem;
      backdrop-filter: blur(20px);
    }

    .charts-header {
      margin-bottom: 2rem;
      text-align: center;
    }

    .charts-header h3 {
      color: #1e293b;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .charts-header p {
      color: #64748b;
      font-size: 0.9rem;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
      min-height: 400px;
    }

    .chart-header {
      margin-bottom: 1rem;
      text-align: center;
    }

    .chart-header h4 {
      color: #1e293b;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .chart-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      position: relative;
    }

    .chart-no-data {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: #94a3b8;
      font-style: italic;
    }

    /* Video Call Interface */
    .video-interface {
      display: none;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 16px;
      padding: 2rem;
      margin-top: 2rem;
    }

    .video-interface.active {
      display: block;
    }

    .video-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .video-main {
      background: #000;
      border-radius: 12px;
      position: relative;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-preview {
      background: #000;
      border-radius: 12px;
      position: relative;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-placeholder {
      color: #64748b;
      font-size: 1.1rem;
      text-align: center;
    }

    .video-controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(15, 15, 15, 0.6);
      border-radius: 12px;
    }

    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: white;
    }

    .control-btn.mute {
      background: #6b7280;
    }

    .control-btn.mute.active {
      background: #ef4444;
    }

    .control-btn.video {
      background: #6b7280;
    }

    .control-btn.video.active {
      background: #3b82f6;
    }

    .control-btn.leave {
      background: #ef4444;
    }

    .control-btn:hover {
      transform: scale(1.1);
    }

    .annotation-info {
      background: rgba(15, 15, 15, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .annotation-info h4 {
      color: #3b82f6;
      margin-bottom: 0.5rem;
    }

    .project-name {
      font-family: 'Courier New', monospace;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="16" fill="url(#gradient)"/>
            <path d="M12 10L20 16L12 22V10Z" fill="white"/>
            <defs>
              <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                <stop stop-color="#3b82f6"/>
                <stop offset="1" stop-color="#10b981"/>
              </linearGradient>
            </defs>
          </svg>
          <h2>Neurotate</h2>
        </div>
      </div>
      
      <div class="sidebar-menu">
        <a href="home-clean.html" class="nav-item active">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 2L3 7V18C3 18.5523 3.44772 19 4 19H7V14H13V19H16C16.5523 19 17 18.5523 17 18V7L10 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Home</span>
        </a>
        
        
        <a href="library.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 4C4 2.89543 4.89543 2 6 2H14C15.1046 2 16 2.89543 16 4V16C16 17.1046 15.1046 18 14 18H6C4.89543 18 4 17.1046 4 16V4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 6H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 10H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 14H10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Library</span>
        </a>

        <a href="faq.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2"/>
            <path d="M7.5 7.5C7.5 6.5 8.5 5.5 10 5.5C11.5 5.5 12.5 6.5 12.5 7.5C12.5 8.5 10 9 10 9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="10" cy="13" r="1" fill="currentColor"/>
          </svg>
          <span>FAQ</span>
        </a>

        <a href="help.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2"/>
            <path d="M10 6V10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 14H10.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span>Help</span>
        </a>
        
        <a href="about.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>About</span>
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <header class="page-header">
        <h1 class="page-title">Welcome to Neurotate Dashboard</h1>
        <p class="page-subtitle">Your UGRA Annotation Hub — Track your contributions, monitor dataset growth, and see the impact your work has on building expert-validated training data for AI models.</p>
      </header>

      <div class="quick-actions">
        <button class="action-btn primary" onclick="startAnnotationSession()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <polygon points="10,8 16,12 10,16" fill="currentColor"/>
          </svg>
          <div>
            <div style="font-weight: 600;">Start Session</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">Begin neural annotation</div>
          </div>
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card" data-stat="images">
          <div class="stat-value">0</div>
          <div class="stat-label">Images Annotated</div>
        </div>
        
        <div class="stat-card" data-stat="annotations">
          <div class="stat-value">0</div>
          <div class="stat-label">Sessions</div>
        </div>
        
        <div class="stat-card" data-stat="time">
          <div class="stat-value">0h</div>
          <div class="stat-label">Session Time</div>
        </div>
        
        <div class="stat-card" data-stat="collaborators">
          <div class="stat-value">0</div>
          <div class="stat-label">Collaborators</div>
        </div>
      </div>

      <!-- Analytics Charts Section -->
      <div class="charts-section">
        <div class="charts-header">
          <h3>Annotation Analytics</h3>
          <p>Distribution of nerve types, patient age groups, and scan regions</p>
        </div>
        
        <div class="charts-grid">
          <div class="chart-container">
            <div class="chart-header">
              <h4>Nerve Type Distribution</h4>
            </div>
            <div class="chart-wrapper">
              <canvas id="nerveTypeChart" width="300" height="300"></canvas>
              <div class="chart-no-data" id="nerveTypeNoData" style="display: none;">
                <p>No nerve type data available</p>
              </div>
            </div>
          </div>
          
          <div class="chart-container">
            <div class="chart-header">
              <h4>Patient Age Group Distribution</h4>
            </div>
            <div class="chart-wrapper">
              <canvas id="ageGroupChart" width="300" height="300"></canvas>
              <div class="chart-no-data" id="ageGroupNoData" style="display: none;">
                <p>No age group data available</p>
              </div>
            </div>
          </div>

          <div class="chart-container">
            <div class="chart-header">
              <h4>Scan Region Distribution</h4>
            </div>
            <div class="chart-wrapper">
              <canvas id="scanRegionChart" width="300" height="300"></canvas>
              <div class="chart-no-data" id="scanRegionNoData" style="display: none;">
                <p>No scan region data available</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      

  <!-- Start Session Modal -->
  <div class="modal-overlay" id="startSessionModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Start New Annotation Session</h2>
        <p class="modal-subtitle">Configure your regional anesthesia annotation session</p>
      </div>
      
      <form id="sessionForm">
        <div class="form-group">
          <label class="form-label">Session Title</label>
          <input type="text" class="form-input" id="sessionTitle" placeholder="e.g., Ultrasound-guided Nerve Block Study" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Doctor Name</label>
          <input type="text" class="form-input" id="doctorName" list="doctorsList" placeholder="e.g., Dr. Smith" required>
          <datalist id="doctorsList">
            <!-- Previous doctors will be populated here -->
          </datalist>
        </div>
        
        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="form-select" id="sessionCategory" required>
            <option value="">Select category...</option>
            <option value="consultation">Consultation</option>
            <option value="training">Training</option>
            <option value="annotation_session">Annotation Session</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Session ID</label>
          <input type="text" class="form-input" id="sessionId" readonly>
        </div>
      </form>
      
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeStartSessionModal()">Cancel</button>
        <button type="button" class="btn-primary" onclick="createAndStartSession()">Start Session</button>
      </div>
    </div>
  </div>

  <style>
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border: 1px solid rgba(59, 130, 246, 0.15);
      border-radius: 12px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(59, 130, 246, 0.1);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .modal-subtitle {
      color: #64748b;
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.9rem;
      background: #ffffff;
      color: #1f2937;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.9rem;
      background: #ffffff;
      color: #1f2937;
      transition: all 0.2s;
    }

    .form-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    .btn-cancel {
      background: #f8fafc;
      border: 1px solid #d1d5db;
      color: #4b5563;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel:hover {
      background: #f1f5f9;
      border-color: #9ca3af;
      color: #374151;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      border: none;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .form-input::placeholder {
      color: #9ca3af;
    }

    .form-input[readonly] {
      background: #f9fafb;
      color: #6b7280;
      cursor: not-allowed;
    }

    .form-select option {
      background: #ffffff;
      color: #1f2937;
    }
  </style>

  <!-- Load scripts in correct order -->
  <script>
    // JavaScript functions for annotation platform
    
    // Start Annotation Session
    async function startAnnotationSession() {
      try {
        console.log(' Getting next session ID from database...');
        
        // Generate next session ID from database
        let nextSessionId;
        if (typeof window.electronAPI !== 'undefined' && window.electronAPI.getNextSessionId) {
          // Production: Use database-based session ID
          console.log(' Using database to get next session ID...');
          const response = await window.electronAPI.getNextSessionId();
          console.log(' Got response from database:', response);
          
          if (response && response.success && response.sessionId) {
            nextSessionId = response.sessionId;
            console.log(' Extracted session ID from database:', nextSessionId);
          } else {
            throw new Error('Invalid response from database: ' + JSON.stringify(response));
          }
        } else {
          // Development: Fallback to localStorage
          console.log(' Using localStorage fallback for session ID...');
          const lastSessionId = parseInt(localStorage.getItem('lastSessionId') || '0');
          nextSessionId = (lastSessionId + 1).toString().padStart(3, '0');
          console.log(' Generated session ID from localStorage:', nextSessionId);
        }
        
        document.getElementById('sessionId').value = nextSessionId;
        
        // Show the session configuration modal
        document.getElementById('startSessionModal').classList.add('active');
      } catch (error) {
        console.error(' Error getting next session ID:', error);
        showToast('Error generating session ID. Please try again.', 'error');
        
        // Fallback to simple incremental ID
        const lastSessionId = parseInt(localStorage.getItem('lastSessionId') || '0');
        const nextSessionId = (lastSessionId + 1).toString().padStart(3, '0');
        document.getElementById('sessionId').value = nextSessionId;
        document.getElementById('startSessionModal').classList.add('active');
      }
    }

    // Close Start Session Modal
    function closeStartSessionModal() {
      document.getElementById('startSessionModal').classList.remove('active');
      document.getElementById('sessionForm').reset();
    }

    // Create and Start Session
    async function createAndStartSession() {
      console.log(' Starting session creation process...');
      
      const title = document.getElementById('sessionTitle').value.trim();
      const doctorName = document.getElementById('doctorName').value.trim();
      const category = document.getElementById('sessionCategory').value;
      const sessionId = document.getElementById('sessionId').value;
      
      console.log(' Session form data:', { title, doctorName, category, sessionId });
      
      if (!title || !doctorName || !category) {
        console.error(' Validation failed: Missing required fields');
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      try {
        // Create session object
        const currentSession = {
          id: sessionId,
          title: title,
          doctor_name: doctorName,
          category: category,
          startTime: new Date().toISOString(),
          sessionStartTime: Date.now(), // Add this for IPC compatibility
          endTime: null,
          annotations: [],
          images: [],
          status: 'active'
        };
        
        console.log(' Created session object:', currentSession);
        
        // Save session data using Electron IPC (for production) or localStorage (for development)
        if (typeof window.electronAPI !== 'undefined' && window.electronAPI.sessionSetData) {
          // Production: Use Electron IPC
          console.log(' Using Electron IPC to save session data...');
          const result = await window.electronAPI.sessionSetData(currentSession);
          console.log(' IPC result:', result);
          if (!result.success) {
            throw new Error('Failed to save session data via IPC');
          }
          console.log(' Session data saved via Electron IPC');
        } else {
          // Development: Use localStorage
          console.log(' Using localStorage to save session data...');
          localStorage.setItem('currentSession', JSON.stringify(currentSession));
          localStorage.setItem('sessionStartTime', Date.now().toString());
          localStorage.setItem('lastSessionId', sessionId);
          console.log(' Session data saved via localStorage');
        }
        
        closeStartSessionModal();
        showToast(`Session #${sessionId} created! Navigating to annotation room...`, 'success');
        
        console.log(' Session created successfully, starting navigation...');
        
        // Navigate to annotation room
        try {
          console.log(' Attempting navigation to annotation room...');
          if (typeof window.electronAPI !== 'undefined' && window.electronAPI.navigateTo) {
            console.log(' Using navigateTo API...');
            const navResult = await window.electronAPI.navigateTo('annotation-room.html');
            console.log(' Navigation result:', navResult);
          } else if (typeof window.electronAPI !== 'undefined' && window.electronAPI.navigate) {
            console.log(' Using navigate API...');
            const navResult = await window.electronAPI.navigate('annotation-room.html');
            console.log(' Navigation result:', navResult);
          } else {
            console.log(' Using window.location fallback...');
            window.location.href = 'annotation-room.html';
          }
        } catch (error) {
          console.error(' Navigation error:', error);
          // Try direct navigation as fallback
          if (typeof window.electronAPI !== 'undefined' && window.electronAPI.navigate) {
            console.log(' Trying navigate fallback...');
            await window.electronAPI.navigate('annotation-room.html');
          } else {
            console.log(' Using window.location as final fallback...');
            window.location.href = 'annotation-room.html';
          }
        }
      } catch (error) {
        console.error(' Session creation failed:', error);
        showToast(`Failed to create session: ${error.message}`, 'error');
      }
    }



    // Toast notification function
    function showToast(message, type = 'success') {
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#ef4444' : type === 'info' ? '#3b82f6' : '#10b981'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 500;
        z-index: 2000;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      
      document.body.appendChild(toast);
      
      // Remove after 3 seconds
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // Add CSS for toast animations
    const toastStyles = document.createElement('style');
    toastStyles.textContent = `
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(toastStyles);

    // Statistics Management Functions
    async function loadStatistics() {
      console.log(' Loading real statistics from database...');
      
      try {
        const stats = await window.statisticsManager.loadStatsFromDatabase();
        console.log(' Statistics loaded:', stats);
        
        // Update the display
        window.statisticsManager.updateStatsDisplay(stats);
        
        // Show last updated info
        if (stats.totalSessions > 0) {
          showToast(`Statistics updated: ${stats.totalSessions} sessions processed`, 'success');
        } else {
          showToast('No session data found - start your first annotation session!', 'info');
        }
        
        // Store current stats for comparison
        window.currentStats = stats;
        
      } catch (error) {
        console.error('❌ Failed to load statistics:', error);
        showToast('Failed to load statistics', 'error');
      }
    }

    // Load unique doctors for dropdown
    async function loadUniqueDoctors() {
      console.log(' Loading unique doctors for dropdown...');
      
      try {
        if (!window.electronAPI || !window.electronAPI.dbGetUniqueDoctors) {
          console.warn(' Database API not available for doctors');
          return;
        }

        const result = await window.electronAPI.dbGetUniqueDoctors();
        
        if (result.success && result.doctors && Array.isArray(result.doctors)) {
          const doctorsList = document.getElementById('doctorsList');
          if (doctorsList) {
            // Clear existing options
            doctorsList.innerHTML = '';
            
            // Add each unique doctor as an option
            result.doctors.forEach(doctor => {
              const option = document.createElement('option');
              option.value = doctor;
              doctorsList.appendChild(option);
            });
            
            console.log(` Loaded ${result.doctors.length} unique doctors:`, result.doctors);
          }
        } else {
          console.warn(' No doctors found or failed to load');
        }
      } catch (error) {
        console.error(' Failed to load unique doctors:', error);
      }
    }

    function setupStatisticsRefresh() {
      // Set up event listeners for statistics refresh
      window.statisticsManager.setupStatisticsUpdater(loadStatistics);
      
      // Refresh statistics every 5 minutes while page is active
      setInterval(async () => {
        if (!document.hidden) {
          console.log(' Auto-refreshing statistics...');
          await loadStatistics();
        }
      }, 5 * 60 * 1000); // 5 minutes
    }

    // Function to trigger statistics refresh (can be called after session completion)
    window.refreshStatistics = async function() {
      await loadStatistics();
      await refreshCharts();
    };

    // Function to handle session completion
    async function handleSessionCompletion(sessionData) {
      console.log(' Session completed, updating statistics...', sessionData);
      
      // Trigger statistics refresh
      await loadStatistics();
      
      // Dispatch custom event for other components
      window.dispatchEvent(new CustomEvent('sessionCompleted', { 
        detail: sessionData 
      }));
      
      showToast('Session completed! Statistics updated.', 'success');
    }

    // Chart management
    let nerveTypeChart = null;
    let ageGroupChart = null;
    let scanRegionChart = null;

    // Initialize charts - Chart.js implementation for data visualization
    // Chart.js: https://www.chartjs.org/ - Open source HTML5 charts library
    function initializeCharts() {
      const nerveTypeCtx = document.getElementById('nerveTypeChart').getContext('2d');
      const ageGroupCtx = document.getElementById('ageGroupChart').getContext('2d');
      const scanRegionCtx = document.getElementById('scanRegionChart').getContext('2d');

      // Nerve Type Chart - Chart.js pie chart implementation
      nerveTypeChart = new Chart(nerveTypeCtx, {
        type: 'pie',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [
              '#7c9cc7', '#6ba88a', '#c9a876', '#c97878', '#a087c7',
              '#6fb3c7', '#a5b573', '#c79670', '#c795a8', '#8a9199'
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Age Group Chart - Chart.js pie chart implementation
      ageGroupChart = new Chart(ageGroupCtx, {
        type: 'pie',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [
              '#7c9cc7', '#6ba88a', '#c9a876', '#c97878', '#a087c7',
              '#6fb3c7', '#a5b573', '#c79670', '#c795a8', '#8a9199'
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Scan Region Chart - Chart.js pie chart implementation
      scanRegionChart = new Chart(scanRegionCtx, {
        type: 'pie',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [
              '#7c9cc7', '#6ba88a', '#c9a876', '#c97878', '#a087c7',
              '#6fb3c7', '#a5b573', '#c79670', '#c795a8', '#8a9199'
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Load and update charts
    async function loadChartData() {
      try {
        console.log(' Loading chart data...');
        
        if (!window.electronAPI || !window.electronAPI.dbGetAnnotationStats) {
          console.warn('Chart data API not available');
          showEmptyCharts();
          return;
        }

        console.log(' Calling dbGetAnnotationStats...');
        const response = await window.electronAPI.dbGetAnnotationStats();
        console.log(' Chart data response:', response);
        
        if (response.success && response.stats) {
          console.log(' Updating charts with stats:', response.stats);
          updateCharts(response.stats);
        } else {
          console.error('Failed to load chart data:', response.error);
          showEmptyCharts();
        }
      } catch (error) {
        console.error('Error loading chart data:', error);
        showEmptyCharts();
      }
    }

    // Update charts with new data - Chart.js data updating methods
    function updateCharts(stats) {
      console.log(' updateCharts called with stats:', stats);
      console.log(' stats keys:', Object.keys(stats));
      console.log(' stats.scanRegions specifically:', stats.scanRegions);
      
      // Update nerve type chart
      const nerveTypes = stats.nerveTypes || {};
      const nerveTypeLabels = Object.keys(nerveTypes);
      const nerveTypeData = Object.values(nerveTypes);

      if (nerveTypeLabels.length > 0) {
        nerveTypeChart.data.labels = nerveTypeLabels;
        nerveTypeChart.data.datasets[0].data = nerveTypeData;
        nerveTypeChart.update();
        document.getElementById('nerveTypeChart').style.display = 'block';
        document.getElementById('nerveTypeNoData').style.display = 'none';
      } else {
        document.getElementById('nerveTypeChart').style.display = 'none';
        document.getElementById('nerveTypeNoData').style.display = 'flex';
      }

      // Update age group chart
      const ageGroups = stats.ageGroups || {};
      const ageGroupLabels = Object.keys(ageGroups);
      const ageGroupData = Object.values(ageGroups);

      if (ageGroupLabels.length > 0) {
        ageGroupChart.data.labels = ageGroupLabels;
        ageGroupChart.data.datasets[0].data = ageGroupData;
        ageGroupChart.update();
        document.getElementById('ageGroupChart').style.display = 'block';
        document.getElementById('ageGroupNoData').style.display = 'none';
      } else {
        document.getElementById('ageGroupChart').style.display = 'none';
        document.getElementById('ageGroupNoData').style.display = 'flex';
      }

      // Update scan region chart
      const scanRegions = stats.scanRegions || {};
      const scanRegionLabels = Object.keys(scanRegions);
      const scanRegionData = Object.values(scanRegions);

      console.log(' Scan Region Chart Debug:');
      console.log('- stats.scanRegions:', stats.scanRegions);
      console.log('- scanRegions object:', scanRegions);
      console.log('- scanRegionLabels:', scanRegionLabels);
      console.log('- scanRegionData:', scanRegionData);
      console.log('- labels length:', scanRegionLabels.length);
      console.log('- scanRegionChart object:', scanRegionChart);

      if (scanRegionLabels.length > 0) {
        console.log(' Updating scan region chart with data');
        if (scanRegionChart) {
          scanRegionChart.data.labels = scanRegionLabels;
          scanRegionChart.data.datasets[0].data = scanRegionData;
          scanRegionChart.update();
          document.getElementById('scanRegionChart').style.display = 'block';
          document.getElementById('scanRegionNoData').style.display = 'none';
          console.log(' Scan region chart updated successfully');
        } else {
          console.error(' scanRegionChart is null or undefined!');
        }
      } else {
        console.log(' No scan region data found, showing empty state');
        document.getElementById('scanRegionChart').style.display = 'none';
        document.getElementById('scanRegionNoData').style.display = 'flex';
      }
    }

    // Show empty state for charts
    function showEmptyCharts() {
      document.getElementById('nerveTypeChart').style.display = 'none';
      document.getElementById('nerveTypeNoData').style.display = 'flex';
      document.getElementById('ageGroupChart').style.display = 'none';
      document.getElementById('ageGroupNoData').style.display = 'flex';
      document.getElementById('scanRegionChart').style.display = 'none';
      document.getElementById('scanRegionNoData').style.display = 'flex';
    }

    // Refresh charts data
    async function refreshCharts() {
      console.log(' Refreshing chart data...');
      await loadChartData();
    }

    // Listen for session completion events from annotation room
    window.addEventListener('message', async (event) => {
      if (event.data && event.data.type === 'sessionCompleted') {
        await handleSessionCompletion(event.data.sessionData);
        // Also refresh charts when session completes
        await refreshCharts();
      }
    });

    // Check for completed sessions when page loads/becomes visible
    window.addEventListener('focus', async () => {
      console.log(' Window focused, checking for session updates...');
      await loadStatistics();
      await refreshCharts();
    });

    // Simple authentication check (no authentication required for local use)
    window.addEventListener('load', async () => {
      console.log(' Neurotate Platform loaded successfully');
      
      // Initialize charts first
      initializeCharts();
      
      // Load and display real statistics
      await loadStatistics();
      
      // Load chart data
      await loadChartData();
      
      // Load unique doctors for dropdown
      await loadUniqueDoctors();
      
      // Set up automatic statistics refresh
      setupStatisticsRefresh();
      
      // Show welcome message
      setTimeout(() => {
        showToast('Welcome to Neurotate Platform!', 'info');
      }, 500);
    });

    // Modal event handlers
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (document.getElementById('startSessionModal').classList.contains('active')) {
          closeStartSessionModal();
        }
      }
    });

    document.addEventListener('click', function(e) {
      if (e.target.id === 'startSessionModal') {
        closeStartSessionModal();
      }
    });
  </script>
</body>
</html>
