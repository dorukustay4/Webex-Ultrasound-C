<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home - Ultrasound Annotation Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="../js/statistics-manager.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
      color: #e2e8f0;
      min-height: 100vh;
    }

    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }

    .sidebar-header {
      padding: 2rem 1.5rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo h2 {
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.25rem;
      font-weight: 700;
    }

    .sidebar-menu {
      flex: 1;
      padding: 1rem 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1.5rem;
      color: #94a3b8;
      text-decoration: none;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #e2e8f0;
    }

    .nav-item.active {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border-left-color: #3b82f6;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 2rem;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      color: #94a3b8;
      font-size: 1.1rem;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
      color: #e2e8f0;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    .action-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
      transform: translateY(-2px);
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      border-color: transparent;
      color: white;
    }

    .action-btn.primary:hover {
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .stat-card.refresh-stats {
      cursor: pointer;
      transition: all 0.2s ease;
      border-color: #10b981;
    }

    .stat-card.refresh-stats:hover {
      background: rgba(16, 185, 129, 0.1);
      border-color: #10b981;
      transform: translateY(-2px);
    }

    .stat-card.refresh-stats .stat-value {
      color: #10b981;
      font-size: 1.5rem;
    }

    .stat-card.refresh-stats .stat-label {
      color: #10b981;
      font-weight: 500;
    }

    /* Video Call Interface */
    .video-interface {
      display: none;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 16px;
      padding: 2rem;
      margin-top: 2rem;
    }

    .video-interface.active {
      display: block;
    }

    .video-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .video-main {
      background: #000;
      border-radius: 12px;
      position: relative;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-preview {
      background: #000;
      border-radius: 12px;
      position: relative;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-placeholder {
      color: #64748b;
      font-size: 1.1rem;
      text-align: center;
    }

    .video-controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(15, 15, 15, 0.6);
      border-radius: 12px;
    }

    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: white;
    }

    .control-btn.mute {
      background: #6b7280;
    }

    .control-btn.mute.active {
      background: #ef4444;
    }

    .control-btn.video {
      background: #6b7280;
    }

    .control-btn.video.active {
      background: #3b82f6;
    }

    .control-btn.leave {
      background: #ef4444;
    }

    .control-btn:hover {
      transform: scale(1.1);
    }

    .annotation-info {
      background: rgba(15, 15, 15, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .annotation-info h4 {
      color: #3b82f6;
      margin-bottom: 0.5rem;
    }

    .project-name {
      font-family: 'Courier New', monospace;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="16" fill="url(#gradient)"/>
            <path d="M12 10L20 16L12 22V10Z" fill="white"/>
            <defs>
              <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                <stop stop-color="#3b82f6"/>
                <stop offset="1" stop-color="#10b981"/>
              </linearGradient>
            </defs>
          </svg>
          <h2>Ultrasound Annotation</h2>
        </div>
      </div>
      
      <div class="sidebar-menu">
        <a href="home-clean.html" class="nav-item active">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 2L3 7V18C3 18.5523 3.44772 19 4 19H7V14H13V19H16C16.5523 19 17 18.5523 17 18V7L10 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Home</span>
        </a>
        
        <a href="test.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2 5C2 3.89543 2.89543 3 4 3H16C17.1046 3 18 3.89543 18 5V15C18 16.1046 17.1046 17 16 17H4C2.89543 17 2 16.1046 2 15V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M6 8L10 12L14 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Test</span>
        </a>
        
        <a href="library.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 4C4 2.89543 4.89543 2 6 2H14C15.1046 2 16 2.89543 16 4V16C16 17.1046 15.1046 18 14 18H6C4.89543 18 4 17.1046 4 16V4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 6H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 10H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 14H10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Library</span>
        </a>
        
        <a href="about.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>About</span>
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <header class="page-header">
        <h1 class="page-title">Welcome to Ultrasound Annotation Platform</h1>
        <p class="page-subtitle">Advanced image annotation platform for medical professionals</p>
      </header>

      <div class="quick-actions">
        <button class="action-btn primary" onclick="startAnnotationSession()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <polygon points="10,8 16,12 10,16" fill="currentColor"/>
          </svg>
          <div>
            <div style="font-weight: 600;">Start Session</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">Begin ultrasound annotation</div>
          </div>
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card" data-stat="images">
          <div class="stat-value">0</div>
          <div class="stat-label">Images Annotated</div>
        </div>
        
        <div class="stat-card" data-stat="annotations">
          <div class="stat-value">0</div>
          <div class="stat-label">Annotations Created</div>
        </div>
        
        <div class="stat-card" data-stat="time">
          <div class="stat-value">0h</div>
          <div class="stat-label">Session Time</div>
        </div>
        
        <div class="stat-card" data-stat="collaborators">
          <div class="stat-value">0</div>
          <div class="stat-label">Collaborators</div>
        </div>
        
        <div class="stat-card refresh-stats" onclick="refreshStatistics()" title="Refresh statistics">
          <div class="stat-value">ðŸ”„</div>
          <div class="stat-label">Refresh Stats</div>
        </div>
      </div>

      <!-- Video Call Interface -->
      <div class="video-interface" id="video-interface">
        <div class="annotation-info" id="annotation-info">
          <h4>Annotation Session</h4>
          <div>Project: <span class="project-name" id="project-name">Ready to annotate</span></div>
          <div>Images: <span id="image-count">0 loaded</span></div>
        </div>

        <div class="video-container">
          <div class="video-main">
            <video id="remote-video" autoplay playsinline style="width: 100%; height: 100%; border-radius: 12px; object-fit: cover;"></video>
            <div class="video-placeholder" id="remote-placeholder">
              Remote participant video will appear here
            </div>
          </div>
          
          <div class="video-preview">
            <video id="local-video" autoplay playsinline muted style="width: 100%; height: 100%; border-radius: 12px; object-fit: cover;"></video>
            <div class="video-placeholder" id="local-placeholder">
              ðŸ“· Your video preview
            </div>
          </div>
        </div>

        <div class="video-controls">
          <button class="control-btn mute" id="mute-btn" onclick="toggleMute()" title="Mute/Unmute">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 1C12.5523 1 13 1.44772 13 2V22C13 22.5523 12.5523 23 12 23C11.4477 23 11 22.5523 11 22V2C11 1.44772 11.4477 1 12 1Z" fill="currentColor"/>
              <path d="M8 6C8.55228 6 9 6.44772 9 7V17C9 17.5523 8.55228 18 8 18C7.44772 18 7 17.5523 7 17V7C7 6.44772 7.44772 6 8 6Z" fill="currentColor"/>
              <path d="M16 6C16.5523 6 17 6.44772 17 7V17C17 17.5523 16.5523 18 16 18C15.4477 18 15 17.5523 15 17V7C15 6.44772 15.4477 6 16 6Z" fill="currentColor"/>
            </svg>
          </button>
          
          <button class="control-btn video" id="video-btn" onclick="toggleVideo()" title="Start/Stop Video">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M23 7L16 12L23 17V7Z" fill="currentColor"/>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
          </button>
          
          <button class="control-btn leave" id="leave-btn" onclick="leaveCall()" title="Leave Call">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22 16.92V18.96C22 19.96 21.96 20.46 20.96 20.46H18.96C16.92 20.46 15.92 19.46 15.92 18.96V16.92C15.92 15.92 16.92 14.92 18.96 14.92H20.96C21.96 14.92 22 15.42 22 16.92Z" fill="currentColor"/>
              <path d="M14 12H10L12 14V10L14 12Z" fill="currentColor"/>
              <path d="M9 12H5C3.89543 12 3 11.1046 3 10C3 8.89543 3.89543 8 5 8H9V12Z" fill="currentColor"/>
            </svg>
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- Start Session Modal -->
  <div class="modal-overlay" id="startSessionModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Start New Annotation Session</h2>
        <p class="modal-subtitle">Configure your regional anesthesia annotation session</p>
      </div>
      
      <form id="sessionForm">
        <div class="form-group">
          <label class="form-label">Session Title</label>
          <input type="text" class="form-input" id="sessionTitle" placeholder="e.g., Ultrasound-guided Nerve Block Study" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Doctor Name</label>
          <input type="text" class="form-input" id="doctorName" placeholder="e.g., Dr. Smith" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="form-select" id="sessionCategory" required>
            <option value="">Select category...</option>
            <option value="consultation">Consultation</option>
            <option value="training">Training</option>
            <option value="annotation_session">Annotation Session</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Session ID</label>
          <input type="text" class="form-input" id="sessionId" readonly>
        </div>
      </form>
      
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeStartSessionModal()">Cancel</button>
        <button type="button" class="btn-primary" onclick="createAndStartSession()">Start Session</button>
      </div>
    </div>
  </div>

  <style>
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border: 1px solid rgba(59, 130, 246, 0.15);
      border-radius: 12px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(59, 130, 246, 0.1);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .modal-subtitle {
      color: #64748b;
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.9rem;
      background: #ffffff;
      color: #1f2937;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.9rem;
      background: #ffffff;
      color: #1f2937;
      transition: all 0.2s;
    }

    .form-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    .btn-cancel {
      background: #f8fafc;
      border: 1px solid #d1d5db;
      color: #4b5563;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel:hover {
      background: #f1f5f9;
      border-color: #9ca3af;
      color: #374151;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      border: none;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .form-input::placeholder {
      color: #9ca3af;
    }

    .form-input[readonly] {
      background: #f9fafb;
      color: #6b7280;
      cursor: not-allowed;
    }

    .form-select option {
      background: #ffffff;
      color: #1f2937;
    }
  </style>

  <!-- Load scripts in correct order -->
  <script>
    // JavaScript functions for annotation platform
    
    // Start Annotation Session
    function startAnnotationSession() {
      // Generate next session ID
      const lastSessionId = parseInt(localStorage.getItem('lastSessionId') || '0');
      const nextSessionId = (lastSessionId + 1).toString().padStart(3, '0');
      document.getElementById('sessionId').value = nextSessionId;
      
      // Show the session configuration modal
      document.getElementById('startSessionModal').classList.add('active');
    }

    // Close Start Session Modal
    function closeStartSessionModal() {
      document.getElementById('startSessionModal').classList.remove('active');
      document.getElementById('sessionForm').reset();
    }

    // Create and Start Session
    async function createAndStartSession() {
      const title = document.getElementById('sessionTitle').value.trim();
      const doctorName = document.getElementById('doctorName').value.trim();
      const category = document.getElementById('sessionCategory').value;
      const sessionId = document.getElementById('sessionId').value;
      
      if (!title || !doctorName || !category) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      // Create session object
      const currentSession = {
        id: sessionId,
        title: title,
        doctor_name: doctorName,
        category: category,
        startTime: new Date().toISOString(),
        endTime: null,
        annotations: [],
        images: [],
        status: 'active'
      };
      
      // Save session data to localStorage for the annotation room
      localStorage.setItem('currentSession', JSON.stringify(currentSession));
      localStorage.setItem('sessionStartTime', Date.now().toString());
      localStorage.setItem('lastSessionId', sessionId);
      
      closeStartSessionModal();
      showToast(`Session #${sessionId} created! Navigating to annotation room...`, 'success');
      
      console.log('ðŸš€ Session created:', currentSession);
      
      // Navigate to annotation room
      try {
        if (typeof window.electronAPI !== 'undefined' && window.electronAPI.navigateTo) {
          await window.electronAPI.navigateTo('annotation-room.html');
        } else {
          window.location.href = 'annotation-room.html';
        }
      } catch (error) {
        console.error('Navigation error:', error);
        window.location.href = 'annotation-room.html';
      }
    }

    // Logout function (simplified for annotation platform)
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear any stored annotation data or session data
        localStorage.removeItem('annotationProjects');
        localStorage.removeItem('userSession');
        sessionStorage.clear();
        
        showToast('Logged out successfully', 'info');
        
        // Redirect to login page
        setTimeout(() => {
          window.location.href = 'login-clean.html';
        }, 1000);
      }
    }

    // Toast notification function
    function showToast(message, type = 'success') {
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#ef4444' : type === 'info' ? '#3b82f6' : '#10b981'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 500;
        z-index: 2000;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      
      document.body.appendChild(toast);
      
      // Remove after 3 seconds
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // Add CSS for toast animations
    const toastStyles = document.createElement('style');
    toastStyles.textContent = `
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(toastStyles);

    // Statistics Management Functions
    async function loadStatistics() {
      console.log('ðŸ“Š Loading real statistics from database...');
      
      // Show loading state
      const refreshCard = document.querySelector('.refresh-stats .stat-value');
      if (refreshCard) {
        refreshCard.textContent = 'â³';
      }
      
      try {
        const stats = await window.statisticsManager.loadStatsFromDatabase();
        console.log('ðŸ“Š Statistics loaded:', stats);
        
        // Update the display
        window.statisticsManager.updateStatsDisplay(stats);
        
        // Reset refresh button
        if (refreshCard) {
          refreshCard.textContent = 'ðŸ”„';
        }
        
        // Show last updated info
        if (stats.totalSessions > 0) {
          showToast(`Statistics updated: ${stats.totalSessions} sessions processed`, 'success');
        } else {
          showToast('No session data found - start your first annotation session!', 'info');
        }
        
        // Store current stats for comparison
        window.currentStats = stats;
        
      } catch (error) {
        console.error('âŒ Failed to load statistics:', error);
        
        // Reset refresh button on error
        if (refreshCard) {
          refreshCard.textContent = 'âŒ';
          setTimeout(() => {
            refreshCard.textContent = 'ðŸ”„';
          }, 2000);
        }
        
        showToast('Failed to load statistics', 'error');
      }
    }

    function setupStatisticsRefresh() {
      // Set up event listeners for statistics refresh
      window.statisticsManager.setupStatisticsUpdater(loadStatistics);
      
      // Refresh statistics every 5 minutes while page is active
      setInterval(async () => {
        if (!document.hidden) {
          console.log('ðŸ“Š Auto-refreshing statistics...');
          await loadStatistics();
        }
      }, 5 * 60 * 1000); // 5 minutes
    }

    // Function to trigger statistics refresh (can be called after session completion)
    window.refreshStatistics = loadStatistics;

    // Function to handle session completion
    async function handleSessionCompletion(sessionData) {
      console.log('ðŸ“Š Session completed, updating statistics...', sessionData);
      
      // Trigger statistics refresh
      await loadStatistics();
      
      // Dispatch custom event for other components
      window.dispatchEvent(new CustomEvent('sessionCompleted', { 
        detail: sessionData 
      }));
      
      showToast('Session completed! Statistics updated.', 'success');
    }

    // Listen for session completion events from annotation room
    window.addEventListener('message', async (event) => {
      if (event.data && event.data.type === 'sessionCompleted') {
        await handleSessionCompletion(event.data.sessionData);
      }
    });

    // Check for completed sessions when page loads/becomes visible
    window.addEventListener('focus', async () => {
      console.log('ðŸ“Š Window focused, checking for session updates...');
      await loadStatistics();
    });

    // Simple authentication check (no authentication required for local use)
    window.addEventListener('load', async () => {
      console.log('ðŸŽ¯ Ultrasound Annotation Platform loaded successfully');
      
      // Load and display real statistics
      await loadStatistics();
      
      // Set up automatic statistics refresh
      setupStatisticsRefresh();
      
      // Show welcome message
      setTimeout(() => {
        showToast('Welcome to Ultrasound Annotation Platform!', 'info');
      }, 500);
    });

    // Modal event handlers
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (document.getElementById('startSessionModal').classList.contains('active')) {
          closeStartSessionModal();
        }
      }
    });

    document.addEventListener('click', function(e) {
      if (e.target.id === 'startSessionModal') {
        closeStartSessionModal();
      }
    });
  </script>
</body>
</html>
