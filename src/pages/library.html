<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Session Library - Ultrasound Webex</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #1e293b;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(59, 130, 246, 0.2);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 1000;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo h2 {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .sidebar-menu {
      flex: 1;
      padding: 1.5rem 1rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      text-decoration: none;
      color: #94a3b8;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s ease;
    }

    .nav-item:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #1e293b;
    }

    .nav-item.active {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .sidebar-user {
      padding: 1rem;
      border-top: 1px solid rgba(59, 130, 246, 0.2);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      display: block;
      font-weight: 500;
      color: #1e293b;
    }

    .user-email {
      display: block;
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .logout-btn {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: none;
      padding: 0.5rem;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 2rem;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-header-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .page-header-text {
      flex: 1;
    }

    .page-header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: #94a3b8;
      font-size: 1.1rem;
    }

    /* Library Content */
    .library-filters {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
    }

    .filter-row {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #94a3b8;
    }

    .filter-input, .filter-select {
      padding: 0.5rem 0.75rem;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(209, 213, 219, 0.8);
      border-radius: 0.5rem;
      color: #1e293b;
      font-size: 0.875rem;
    }

    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .calls-list {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 1rem;
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .calls-table {
      width: 100%;
      border-collapse: collapse;
    }

    .calls-table th {
      background: rgba(248, 250, 252, 0.9);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #1e293b;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
      font-size: 0.875rem;
    }

    .calls-table td {
      padding: 1rem;
      border-bottom: 1px solid rgba(226, 232, 240, 0.5);
      color: #64748b;
      font-size: 0.875rem;
    }

    .calls-table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .call-title-cell {
      color: #1e293b;
      font-weight: 500;
    }

    .call-date-cell {
      white-space: nowrap;
    }

    .call-status {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-block;
    }

    .call-status.completed {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .call-status.archived {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .resident-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .resident-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: white;
      font-weight: 600;
    }

    .annotations-count {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-weight: 600;
      display: inline-block;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      padding: 0.375rem 0.75rem;
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 0.375rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
    }

    .action-btn:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .action-btn.export {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border-color: rgba(16, 185, 129, 0.2);
    }

    .action-btn.export:hover {
      background: rgba(16, 185, 129, 0.2);
    }

    .action-btn.delete {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.2);
    }

    .action-btn.delete:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #94a3b8;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .empty-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .empty-subtitle {
      font-size: 0.875rem;
    }

    /* Session Display Styles */
    .session-date .date {
      font-weight: 500;
      color: #1e293b;
    }

    .session-date .time {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 2px;
    }

    .session-title strong {
      color: #1e293b;
      display: block;
      margin-bottom: 2px;
    }

    .session-category {
      font-size: 0.75rem;
      color: #94a3b8;
      text-transform: capitalize;
    }

    .attendee-info .attendee-name {
      color: #1e293b;
      font-weight: 500;
    }

    .duration {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
      color: #1e293b;
      font-weight: 500;
    }

    .session-category-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .category-consultation {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .category-training {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .category-annotation-session {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .annotation-stats {
      text-align: center;
    }

    .annotation-count {
      font-weight: 600;
      font-size: 1.1rem;
      color: #3b82f6;
      display: block;
    }

    .annotation-label {
      font-size: 0.75rem;
      color: #94a3b8;
      text-transform: lowercase;
    }

    .image-count {
      font-size: 0.75rem;
      color: #f59e0b;
      font-weight: 500;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .main-content {
        margin-left: 0;
        padding: 1rem;
      }
      
      .calls-table {
        font-size: 0.75rem;
      }
      
      .calls-table th,
      .calls-table td {
        padding: 0.5rem;
      }
      
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 0.25rem;
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .close:hover,
    .close:focus {
      opacity: 1;
    }

    .modal-body {
      padding: 30px;
      max-height: calc(90vh - 100px);
      overflow-y: auto;
    }

    .session-info {
      background: #f8fafc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
      border-left: 4px solid #3b82f6;
    }

    .session-info h3 {
      color: #1e293b;
      margin-bottom: 15px;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .session-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .session-info-item {
      display: flex;
      flex-direction: column;
    }

    .session-info-label {
      font-size: 0.85rem;
      color: #64748b;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .session-info-value {
      color: #1e293b;
      font-weight: 500;
    }

    .annotations-list {
      background: white;
    }

    .annotations-list h3 {
      color: #1e293b;
      margin-bottom: 20px;
      font-size: 1.2rem;
      font-weight: 600;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
    }

    .annotation-card {
      background: #f8fafc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .annotation-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: #3b82f6;
    }

    .annotation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .annotation-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
    }

    .annotation-timestamp {
      font-size: 0.85rem;
      color: #64748b;
    }

    .annotation-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .annotation-detail {
      display: flex;
      flex-direction: column;
    }

    .annotation-detail-label {
      font-size: 0.8rem;
      color: #64748b;
      font-weight: 500;
      margin-bottom: 3px;
    }

    .annotation-detail-value {
      color: #1e293b;
      font-weight: 500;
      padding: 4px 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
    }

    .clinical-notes {
      grid-column: 1 / -1;
      margin-top: 10px;
    }

    .clinical-notes-content {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px;
      min-height: 60px;
      font-style: italic;
      color: #475569;
      line-height: 1.5;
    }

    .empty-annotations {
      text-align: center;
      color: #64748b;
      font-style: italic;
      padding: 40px 20px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="16" fill="url(#gradient)"/>
            <path d="M12 10L20 16L12 22V10Z" fill="white"/>
            <defs>
              <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                <stop stop-color="#3b82f6"/>
                <stop offset="1" stop-color="#10b981"/>
              </linearGradient>
            </defs>
          </svg>
          <h2>Ultrasound Annotation</h2>
        </div>
      </div>
      
      <div class="sidebar-menu">
        <a href="home-clean.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 2L3 7V18C3 18.5523 3.44772 19 4 19H7V14H13V19H16C16.5523 19 17 18.5523 17 18V7L10 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Home</span>
        </a>
        
        <a href="test.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2 5C2 3.89543 2.89543 3 4 3H16C17.1046 3 18 3.89543 18 5V15C18 16.1046 17.1046 17 16 17H4C2.89543 17 2 16.1046 2 15V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M6 8L10 12L14 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Test</span>
        </a>
        
        <a href="library.html" class="nav-item active">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 4C4 2.89543 4.89543 2 6 2H14C15.1046 2 16 2.89543 16 4V16C16 17.1046 15.1046 18 14 18H6C4.89543 18 4 17.1046 4 16V4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 6H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 10H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 14H10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Library</span>
        </a>

        <a href="faq.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2"/>
            <path d="M7.5 7.5C7.5 6.5 8.5 5.5 10 5.5C11.5 5.5 12.5 6.5 12.5 7.5C12.5 8.5 10 9 10 9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="10" cy="13" r="1" fill="currentColor"/>
          </svg>
          <span>FAQ</span>
        </a>

        <a href="help.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2"/>
            <path d="M10 6V10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 14H10.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span>Help</span>
        </a>
        
        <a href="about.html" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>About</span>
        </a>
      </div>
      
      <div class="sidebar-user" id="sidebar-user" style="display: none;">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-info">
          <span class="user-name" id="user-name">User</span>
          <span class="user-email" id="user-email">user@example.com</span>
        </div>
        <button class="logout-btn" onclick="logout()" title="Sign Out">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 3H5C3.89543 3 3 3.89543 3 5V15C3 16.1046 3.89543 17 5 17H9M13 7L17 11M17 11L13 15M17 11H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <div class="page-header-content">
          <div class="page-header-text">
            <h1 class="page-title">Session Library</h1>
            <p class="page-subtitle">View your session history, annotations, and shared ultrasound appointments</p>
          </div>
        </div>
      </div>


      <!-- Sessions List -->
      <div class="calls-list" id="calls-list">
        <table class="calls-table">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Session Title</th>
              <th>Resident Doctor</th>
              <th>Duration</th>
              <th>Category</th>
              <th>Annotations</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="calls-tbody">
            <!-- Session rows will be dynamically generated here -->
          </tbody>
        </table>
      </div>

      <!-- Empty State (shown when no sessions) -->
      <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-icon"></div>
        <div class="empty-title">No sessions found</div>
        <div class="empty-subtitle">Start a new ultrasound session to see your session history here</div>
      </div>
    </main>
  </div>

  <!-- Authentication system loaded via main app - removed broken import -->

  <script>
    let allSessions = [];
    let filteredSessions = [];

    // Manual refresh function for debugging
    async function manualRefresh() {
      console.log('ðŸ”„ Manual refresh triggered');
      try {
        await loadSessionsFromDatabase();
        console.log('âœ… Manual refresh completed');
      } catch (error) {
        console.error('âŒ Manual refresh failed:', error);
      }
    }
    
    // Make manual refresh available globally
    window.manualRefresh = manualRefresh;

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 500;
        z-index: 2000;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 300px;
        font-size: 0.9rem;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 4000);
    }

    // Debug function to check library state
    function debugLibrary() {
      console.log('ðŸ” Library Debug Info:');
      console.log('- All sessions count:', allSessions.length);
      console.log('- Filtered sessions count:', filteredSessions.length);
      console.log('- electronAPI available:', !!window.electronAPI);
      console.log('- dbGetSessions available:', !!(window.electronAPI && window.electronAPI.dbGetSessions));
      
      // Detailed session analysis
      if (allSessions.length > 0) {
        console.log('ðŸ“Š Session Details:');
        allSessions.forEach((session, index) => {
          console.log(`Session ${index + 1}: "${session.title}"`);
          console.log(`  - ID: ${session.id}`);
          console.log(`  - Stored Annotations: ${session.storedAnnotations}`);
          console.log(`  - Actual Annotations: ${session.actualAnnotations}`);
          console.log(`  - Displayed Annotations: ${session.annotations}`);
          console.log(`  - Stored Images: ${session.storedImages}`);
          console.log(`  - Actual Images: ${session.actualImages}`);
          console.log(`  - Displayed Images: ${session.images}`);
          console.log(`  - Status: ${session.status}`);
          console.log(`  - Date: ${session.date}`);
          console.log('---');
        });
      }
      
      return {
        allSessions: allSessions.length,
        filteredSessions: filteredSessions.length,
        hasAPI: !!window.electronAPI,
        hasDBGetSessions: !!(window.electronAPI && window.electronAPI.dbGetSessions),
        sessions: allSessions.map(s => ({
          id: s.id,
          title: s.title,
          storedAnnotations: s.storedAnnotations,
          actualAnnotations: s.actualAnnotations,
          displayedAnnotations: s.annotations
        }))
      };
    }

    // Make debug function available globally
    window.debugLibrary = debugLibrary;

    // Test function to add sample data if database is empty
    function addTestSession() {
      const testSession = {
        id: 'test_' + Date.now(),
        title: 'Test Session - ' + new Date().toLocaleTimeString(),
        date: new Date().toISOString(),
        duration: 300000,
        attendees: 'Dr. Test',
        category: 'annotation_session',
        status: 'completed',
        annotations: 5,
        images: 3,
        startTime: new Date().toISOString(),
        endTime: new Date().toISOString(),
        createdAt: new Date().toISOString(),
        notes: 'Test session created manually'
      };
      
      allSessions.push(testSession);
      console.log('âž• Added test session:', testSession);
      showToast('Test session added!', 'success');
      applyFilters();
    }

    // Make test function available globally
    window.addTestSession = addTestSession;

    // Direct database check function
    async function checkDatabase() {
      console.log('ðŸ” Direct database check...');
      
      if (window.electronAPI && window.electronAPI.dbGetSessions) {
        try {
          const result = await window.electronAPI.dbGetSessions();
          console.log('ðŸ“Š Raw database result:', result);
          
          if (result.success && result.sessions) {
            console.log(`âœ… Found ${result.sessions.length} sessions in database:`);
            result.sessions.forEach((session, index) => {
              console.log(`Session ${index + 1}:`, {
                id: session.id,
                title: session.title,
                attendees: session.attendees,
                total_annotations: session.total_annotations,
                actual_annotations: session.actual_annotations,
                start_time: session.start_time,
                status: session.status
              });
            });
            return result.sessions;
          } else {
            console.log('âŒ No sessions or error:', result.error);
            return [];
          }
        } catch (error) {
          console.error('âŒ Database check error:', error);
          return [];
        }
      } else {
        console.error('âŒ electronAPI not available');
        return [];
      }
    }

    // Make database check available globally
    window.checkDatabase = checkDatabase;

    // Add debug function to create a test session for verification
    async function createTestSession() {
      console.log('ðŸ§ª Creating test session for debugging...');
      
      const testSession = {
        id: 'test_' + Date.now(),
        title: 'Debug Test Session',
        attendees: 'Test Doctor',
        category: 'annotation_session',
        startTime: new Date().toISOString(),
        endTime: new Date().toISOString(),
        duration: 120000, // 2 minutes
        totalAnnotations: 2,
        totalImages: 1,
        status: 'completed'
      };
      
      console.log('ðŸ”„ Sending test session to database:', testSession);
      
      if (window.electronAPI && window.electronAPI.dbSaveSession) {
        try {
          const result = await window.electronAPI.dbSaveSession(testSession);
          console.log('ðŸ“Š Test session save result:', result);
          
          if (result.success) {
            console.log('âœ… Test session saved successfully!');
            showToast('Test session created successfully!', 'success');
            
            // Reload sessions to see if it appears
            await loadSessionsFromDatabase();
            await renderSessions();
            
            return testSession.id;
          } else {
            console.error('âŒ Test session save failed:', result.error);
            showToast('Test session save failed: ' + result.error, 'error');
            return null;
          }
        } catch (error) {
          console.error('âŒ Test session creation error:', error);
          showToast('Test session creation error: ' + error.message, 'error');
          return null;
        }
      } else {
        console.error('âŒ Database API not available for test session');
        showToast('Database API not available', 'error');
        return null;
      }
    }
    
    // Make test session function available globally
    window.createTestSession = createTestSession;

    // Comprehensive debug function to test the entire pipeline
    async function debugFullPipeline() {
      console.log('ðŸ” ==========================================================');
      console.log('ðŸ” STARTING COMPREHENSIVE DATABASE DEBUG');
      console.log('ðŸ” ==========================================================');
      
      // Step 1: Check API availability
      console.log('ðŸ“‹ Step 1: Checking API availability...');
      console.log('- window.electronAPI:', !!window.electronAPI);
      if (window.electronAPI) {
        console.log('- Available methods:', Object.keys(window.electronAPI));
        console.log('- dbSaveSession:', !!window.electronAPI.dbSaveSession);
        console.log('- dbGetSessions:', !!window.electronAPI.dbGetSessions);
      }
      
      // Step 2: Check current database contents
      console.log('\nðŸ“‹ Step 2: Checking current database contents...');
      const existingSessions = await checkDatabase();
      console.log(`- Found ${existingSessions.length} existing sessions`);
      
      // Step 3: Create a test session
      console.log('\nðŸ“‹ Step 3: Creating test session...');
      const testSessionId = await createTestSession();
      if (!testSessionId) {
        console.error('âŒ Test session creation failed, stopping debug');
        return;
      }
      
      // Step 4: Immediately check if it was saved
      console.log('\nðŸ“‹ Step 4: Verifying test session was saved...');
      const updatedSessions = await checkDatabase();
      console.log(`- Found ${updatedSessions.length} sessions after test creation`);
      
      const testSession = updatedSessions.find(s => s.id === testSessionId);
      if (testSession) {
        console.log('âœ… Test session found in database:', testSession);
      } else {
        console.error('âŒ Test session NOT found in database!');
      }
      
      // Step 5: Test the UI loading process
      console.log('\nðŸ“‹ Step 5: Testing UI loading process...');
      await loadSessionsFromDatabase();
      console.log(`- allSessions length after load: ${allSessions.length}`);
      console.log('- allSessions content:', allSessions);
      
      // Step 6: Test filtering
      console.log('\nðŸ“‹ Step 6: Testing filtering...');
      const filteredSessions = applyFilters();
      console.log(`- Filtered sessions length: ${filteredSessions.length}`);
      console.log('- Filtered sessions:', filteredSessions);
      
      // Step 7: Test rendering
      console.log('\nðŸ“‹ Step 7: Testing rendering...');
      await renderSessions();
      
      const tableBody = document.querySelector('.sessions-table tbody');
      const rows = tableBody ? tableBody.children.length : 0;
      console.log(`- Table rows rendered: ${rows}`);
      
      console.log('ðŸ” ==========================================================');
      console.log('ðŸ” DEBUG COMPLETE - Check the logs above for issues');
      console.log('ðŸ” ==========================================================');
      
      return {
        apiAvailable: !!window.electronAPI,
        existingSessionsCount: existingSessions.length,
        testSessionCreated: !!testSessionId,
        testSessionInDb: !!testSession,
        loadedSessionsCount: allSessions.length,
        filteredSessionsCount: filteredSessions.length,
        renderedRowsCount: rows
      };
    }
    
    // Make comprehensive debug available globally
    window.debugFullPipeline = debugFullPipeline;

    // Simple debug function to check what status values are actually in the database
    async function debugStatusValues() {
      console.log('ðŸ” Checking actual status values in database...');
      
      const sessions = await checkDatabase();
      if (sessions.length > 0) {
        const statusCounts = {};
        sessions.forEach(session => {
          const status = session.status || 'null/undefined';
          statusCounts[status] = (statusCounts[status] || 0) + 1;
        });
        
        console.log('ðŸ“Š Status distribution in database:');
        Object.entries(statusCounts).forEach(([status, count]) => {
          console.log(`  - "${status}": ${count} sessions`);
        });
        
        console.log('\nðŸ“‹ Sample sessions with status:');
        sessions.slice(0, 5).forEach((session, index) => {
          console.log(`${index + 1}. "${session.title}" - status: "${session.status}"`);
        });
        
        return statusCounts;
      } else {
        console.log('âŒ No sessions found in database');
        return {};
      }
    }
    
    // Make status debug available globally
    window.debugStatusValues = debugStatusValues;

    // Simple render function that shows ALL sessions without any filtering
    function renderAllSessions() {
      console.log('ðŸŽ¨ renderAllSessions called - SHOWING ALL SESSIONS WITHOUT FILTERS');
      console.log('ðŸŽ¨ allSessions.length:', allSessions.length);
      
      const tbody = document.getElementById('calls-tbody');
      const emptyState = document.getElementById('empty-state');
      const callsList = document.getElementById('calls-list');

      if (!tbody) {
        console.error('âŒ calls-tbody element not found');
        return;
      }
      
      console.log('ðŸŽ¨ DOM elements found:', { tbody: !!tbody, emptyState: !!emptyState, callsList: !!callsList });

      // Clear existing content
      tbody.innerHTML = '';

      if (allSessions.length === 0) {
        console.log('ðŸŽ¨ No sessions in allSessions array, showing empty state');
        if (callsList) callsList.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        return;
      }

      console.log('ðŸŽ¨ Displaying ALL sessions in table WITHOUT filtering');
      if (callsList) callsList.style.display = 'block';
      if (emptyState) emptyState.style.display = 'none';

      // Sort sessions by date (newest first) but show ALL of them
      const sortedSessions = [...allSessions].sort((a, b) => 
        new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date)
      );

      console.log('ðŸŽ¨ Sorted ALL sessions:', sortedSessions.map(s => ({ 
        id: s.id, 
        title: s.title, 
        date: s.date,
        status: s.status,
        annotations: s.annotations 
      })));

      sortedSessions.forEach((session, index) => {
        console.log(`ðŸŽ¨ Creating row for session ${index + 1}:`, {
          id: session.id,
          title: session.title,
          status: session.status,
          annotations: session.annotations,
          images: session.images
        });
        
        console.log(`ðŸŽ¨ About to call createSessionRow for session:`, session);
        
        try {
          const row = createSessionRow(session);
          console.log(`ðŸŽ¨ createSessionRow returned:`, row);
          console.log(`ðŸŽ¨ Row type:`, typeof row);
          console.log(`ðŸŽ¨ Row constructor:`, row ? row.constructor.name : 'null');
          
          if (row && row.nodeType === Node.ELEMENT_NODE) {
            tbody.appendChild(row);
            console.log(`âœ… Row ${index + 1} added successfully`);
          } else {
            console.error(`âŒ createSessionRow returned invalid node for session ${index + 1}:`, row);
            console.error(`âŒ Session data:`, session);
          }
        } catch (error) {
          console.error(`âŒ Error in row creation/append for session ${index + 1}:`, error);
          console.error(`âŒ Session data:`, session);
        }
      });

      console.log(`ðŸ“Š Rendered ALL ${sortedSessions.length} sessions in library (NO FILTERING)`);
    }

    // Load sessions from database
    async function loadSessionsFromDatabase() {
      try {
        console.log('ðŸ”„ Loading sessions from SQLite database...');
        console.log('- electronAPI available:', !!window.electronAPI);
        console.log('- dbGetSessions available:', !!(window.electronAPI && window.electronAPI.dbGetSessions));
        
        if (window.electronAPI && window.electronAPI.dbGetSessions) {
          const result = await window.electronAPI.dbGetSessions();
          
          console.log('ðŸ“Š Database response:', result);
          console.log('- Success:', result.success);
          console.log('- Sessions array:', result.sessions);
          console.log('- Sessions length:', result.sessions ? result.sessions.length : 'null');
          
          if (result.success && result.sessions && Array.isArray(result.sessions)) {
            console.log(`âœ… Raw sessions from database (${result.sessions.length} found):`, result.sessions);
            
            // Process each session with detailed logging
            allSessions = result.sessions.map((session, index) => {
              console.log(`Processing session ${index + 1}:`, session);
              console.log(`  - Raw status from DB: "${session.status}"`);
              
              const processedSession = {
                id: session.id,
                title: session.title || 'Untitled Session',
                date: session.start_time || session.startTime || session.created_at,
                duration: session.duration || 0,
                attendees: session.attendees || session.doctor_name || 'Not specified',
                category: session.category || 'annotation_session',
                // For ended sessions, treat them as completed regardless of stored status
                status: session.status || 'completed',
                // Use stored totals first, fallback to actual counts
                annotations: session.total_annotations || session.actual_annotations || 0,
                images: session.total_images || session.actual_images || 0,
                startTime: session.start_time || session.startTime,
                endTime: session.end_time || session.endTime,
                createdAt: session.created_at || session.start_time,
                notes: session.notes || '',
                // Also store raw database values for debugging
                storedAnnotations: session.total_annotations,
                actualAnnotations: session.actual_annotations,
                storedImages: session.total_images,
                actualImages: session.actual_images
              };
              
              console.log(`Processed session ${index + 1}:`, processedSession);
              console.log(`  - Final status: "${processedSession.status}"`);
              return processedSession;
            });
            
            console.log(`âœ… Final processed sessions (${allSessions.length}):`, allSessions);
            
            // Show success message
            showToast(`Loaded ${allSessions.length} sessions from database`, 'success');
            
            // SKIP FILTERING - RENDER ALL SESSIONS DIRECTLY
            console.log('ðŸš€ SKIPPING ALL FILTERS - RENDERING ALL SESSIONS DIRECTLY');
            renderAllSessions();
            
          } else {
            console.warn('âš ï¸ No sessions found or failed to load. Details:');
            console.warn('- result.success:', result.success);
            console.warn('- result.sessions exists:', !!result.sessions);
            console.warn('- result.sessions is array:', Array.isArray(result.sessions));
            console.warn('- result.error:', result.error);
            
            allSessions = [];
            showToast(result.error || 'No sessions found in database', 'info');
          }
        } else {
          console.error('âŒ Database API not available');
          console.error('- window.electronAPI:', !!window.electronAPI);
          if (window.electronAPI) {
            console.error('- Available methods:', Object.keys(window.electronAPI));
          }
          showToast('Database connection not available', 'error');
          allSessions = [];
        }
      } catch (error) {
        console.error('âŒ Error loading sessions:', error);
        console.error('- Error details:', error.message, error.stack);
        showToast('Error loading sessions from database', 'error');
        allSessions = [];
      }
      
      console.log('ï¿½ SKIPPING ALL FILTERS - FINAL allSessions.length:', allSessions.length);
      
      // RENDER ALL SESSIONS WITHOUT ANY FILTERING
      renderAllSessions();
    }

    // Update resident filter with actual attendees from database
    function updateResidentFilterOptions() {
      const residentFilter = document.getElementById('resident-filter');
      if (!residentFilter) return;
      
      // Get unique attendees from sessions
      const attendees = [...new Set(allSessions.map(session => session.attendees).filter(Boolean))];
      
      // Clear existing options except "All residents"
      residentFilter.innerHTML = '<option value="all">All residents</option>';
      
      // Add unique attendees
      attendees.forEach(attendee => {
        const option = document.createElement('option');
        option.value = attendee;
        option.textContent = attendee;
        residentFilter.appendChild(option);
      });
    }

    // Format duration from milliseconds to readable format
    function formatDuration(milliseconds) {
      if (!milliseconds) return '00:00:00';
      
      const totalSeconds = Math.floor(milliseconds / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      } else {
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('ðŸ“š Session Library page loading...');
      console.log('ðŸ“š DOM fully loaded, starting initialization');
      console.log('ðŸ“š Window.electronAPI available:', !!window.electronAPI);
      
      // Check if essential DOM elements exist
      const tbody = document.getElementById('calls-tbody');
      const emptyState = document.getElementById('empty-state');
      const callsList = document.getElementById('calls-list');
      console.log('ðŸ“š DOM elements check:', {
        tbody: !!tbody,
        emptyState: !!emptyState, 
        callsList: !!callsList
      });
      
      // Test database connectivity immediately
      if (window.electronAPI && window.electronAPI.dbGetSessions) {
        console.log('ðŸ“š Testing database connection...');
        try {
          const testResult = await window.electronAPI.dbGetSessions();
          console.log('ðŸ“š Database test result:', testResult);
        } catch (error) {
          console.error('ðŸ“š Database test error:', error);
        }
      } else {
        console.error('ðŸ“š Database API not available!');
      }
      
      // Load authentication state
      initializeAuth();
      
      // Set up event listeners
      setupEventListeners();
      
      // Load sessions from database
      console.log('ðŸ“š About to call loadSessionsFromDatabase...');
      try {
        await loadSessionsFromDatabase();
        console.log('ðŸ“š loadSessionsFromDatabase completed');
      } catch (error) {
        console.error('ðŸ“š loadSessionsFromDatabase failed:', error);
      }
      
      console.log('âœ… Session Library initialized');
      console.log('ðŸ“š Final state - allSessions.length:', allSessions.length);
    });

    // Initialize authentication
    function initializeAuth() {
      try {
        if (typeof isAuthenticated === 'function' && isAuthenticated()) {
          const user = getCurrentUser();
          if (user) {
            updateUserDisplay(user);
          }
        } else {
          console.log('User not authenticated, continuing with library access');
        }
      } catch (error) {
        console.log('Auth system not available, continuing with library access');
      }
    }



    // Set up event listeners - DISABLED FOR DEBUGGING
    function setupEventListeners() {
      console.log('ðŸš€ Event listeners DISABLED - no filtering will be applied');
      // const searchFilter = document.getElementById('search-filter');
      // const dateFilter = document.getElementById('date-filter');
      // const statusFilter = document.getElementById('status-filter');
      // const residentFilter = document.getElementById('resident-filter');

      // [searchFilter, dateFilter, statusFilter, residentFilter].forEach(filter => {
      //   if (filter) {
      //     filter.addEventListener('change', applyFilters);
      //     filter.addEventListener('input', applyFilters);
      //   }
      // });
    }

    // Apply filters to sessions
    function applyFilters() {
      console.log('ðŸ”§ applyFilters called. allSessions.length:', allSessions.length);
      
      const searchTerm = document.getElementById('search-filter')?.value?.toLowerCase() || '';
      const dateRange = document.getElementById('date-filter')?.value || 'all';
      const resident = document.getElementById('resident-filter')?.value || 'all';

      console.log('ðŸ”§ Filter values:', { searchTerm, dateRange, resident });

      filteredSessions = allSessions.filter(session => {
        // Search filter
        const matchesSearch = !searchTerm || 
          session.title.toLowerCase().includes(searchTerm) ||
          (session.attendees && session.attendees.toLowerCase().includes(searchTerm)) ||
          (session.notes && session.notes.toLowerCase().includes(searchTerm));

        // Date filter
        const sessionDate = new Date(session.createdAt || session.date);
        const now = new Date();
        let matchesDate = true;
        
        if (dateRange === 'today') {
          matchesDate = sessionDate.toDateString() === now.toDateString();
        } else if (dateRange === 'week') {
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          matchesDate = sessionDate >= weekAgo;
        } else if (dateRange === 'month') {
          const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          matchesDate = sessionDate >= monthAgo;
        } else if (dateRange === 'quarter') {
          const quarterAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
          matchesDate = sessionDate >= quarterAgo;
        }

        // Resident filter
        const matchesResident = resident === 'all' || session.attendees === resident;

        const matches = matchesSearch && matchesDate && matchesResident;
        
        if (!matches) {
          console.log(`ðŸ”§ Session "${session.title}" filtered out:`, {
            matchesSearch, matchesDate, matchesStatus, matchesResident
          });
        }

        return matches;
      });

      console.log(`ðŸ”§ After filtering: ${filteredSessions.length} of ${allSessions.length} sessions match`);
      console.log('ðŸ”§ Filtered sessions:', filteredSessions);

      renderSessions();
    }

    // Render sessions in table
    function renderSessions() {
      console.log('ðŸŽ¨ renderSessions called. filteredSessions.length:', filteredSessions.length);
      
      const tbody = document.getElementById('calls-tbody');
      const emptyState = document.getElementById('empty-state');
      const callsList = document.getElementById('calls-list');

      if (!tbody) {
        console.error('âŒ calls-tbody element not found');
        return;
      }
      
      console.log('ðŸŽ¨ DOM elements found:', { tbody: !!tbody, emptyState: !!emptyState, callsList: !!callsList });

      // Clear existing content
      tbody.innerHTML = '';

      if (filteredSessions.length === 0) {
        console.log('ðŸŽ¨ No sessions to display, showing empty state');
        if (callsList) callsList.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        return;
      }

      console.log('ðŸŽ¨ Displaying sessions table');
      if (callsList) callsList.style.display = 'block';
      if (emptyState) emptyState.style.display = 'none';

      // Sort sessions by date (newest first)
      const sortedSessions = [...filteredSessions].sort((a, b) => 
        new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date)
      );

      console.log('ðŸŽ¨ Sorted sessions:', sortedSessions.map(s => ({ id: s.id, title: s.title, date: s.date })));

      sortedSessions.forEach((session, index) => {
        console.log(`ðŸŽ¨ Creating row for session ${index + 1}:`, session);
        const row = createSessionRow(session);
        tbody.appendChild(row);
      });

      console.log(`ðŸ“Š Rendered ${sortedSessions.length} sessions in library`);
    }

    // Create session row HTML
    function createSessionRow(session) {
      try {
        console.log('ðŸŽ¨ Creating row for:', session.id);
        
        const row = document.createElement('tr');
        
        // Safely get date with fallbacks
        const dateValue = session.date || session.start_time || session.createdAt || new Date().toISOString();
        const sessionDate = new Date(dateValue);
        
        // Check if date is valid
        if (isNaN(sessionDate.getTime())) {
          console.warn('Invalid date for session:', session.id, 'using current date');
          sessionDate.setTime(Date.now());
        }
        
        const formattedDate = sessionDate.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        const formattedTime = sessionDate.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit'
        });

        // Format session category for display
        const category = session.category || 'annotation_session';
        const sessionCategory = formatCategory(category);
        let categoryClass = 'session-category-badge';
        
        // Add specific class based on category from database
        if (category === 'consultation') {
          categoryClass += ' category-consultation';
        } else if (category === 'training') {
          categoryClass += ' category-training';
        } else if (category === 'annotation_session') {
          categoryClass += ' category-annotation-session';
        } else {
          // Fallback for any other category
          categoryClass += ' category-annotation-session';
        }

        // Create avatar from doctor name - safely
        const attendees = session.attendees || session.doctor_name || 'DR';
        const avatar = attendees.split(' ').map(n => n[0] || 'D').join('');

        // Format duration from seconds - safely
        const duration = formatDuration(session.duration || 0);

        row.innerHTML = `
          <td class="call-date-cell">
            <div>${formattedDate}</div>
            <div style="font-size: 0.75rem; color: #6b7280;">${formattedTime}</div>
          </td>
          <td class="call-title-cell">${escapeHtml(session.title || 'Untitled Session')}</td>
          <td>
            <div class="resident-info">
              <div class="resident-avatar">${escapeHtml(avatar)}</div>
              <span>${escapeHtml(attendees)}</span>
            </div>
          </td>
          <td>${duration}</td>
          <td>
            <span class="${categoryClass}">${sessionCategory}</span>
          </td>
          <td>
            <span class="annotations-count">${session.annotations || session.total_annotations || 0}</span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="action-btn" onclick="viewSessionDetails('${session.id}')">
                View
              </button>
              <button class="action-btn delete" onclick="deleteSession('${session.id}')">
                Delete
              </button>
              <button class="action-btn export" onclick="exportSession('${session.id}')">
                Export
              </button>
            </div>
          </td>
        `;
        
        console.log('âœ… Row created successfully for session:', session.id);
        return row;
        
      } catch (error) {
        console.error('âŒ Error creating row for session:', session.id, error);
        console.error('Session data:', session);
        return null;
      }
    }

    // Helper functions
    function escapeHtml(text) {
      if (!text) return '';
      try {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      } catch (error) {
        console.warn('Error escaping HTML for text:', text, error);
        return String(text || '');
      }
    }

    function formatCategory(category) {
      if (!category) return 'Annotation Session';
      try {
        return category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      } catch (error) {
        console.warn('Error formatting category:', category, error);
        return 'Annotation Session';
      }
    }

    // Apply current filters to sessions
    function applyFilters() {
      console.log('ðŸ” Applying filters to sessions...');
      console.log('- allSessions count:', allSessions.length);
      
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const dateRange = document.getElementById('date-filter').value;
      const resident = document.getElementById('resident-filter').value;

      console.log('- Filter values:', { searchTerm, dateRange, resident });

      const now = new Date();
      
      const filtered = allSessions.filter(session => {
        console.log(`Checking session: ${session.id} - ${session.title}`);
        
        // Search filter
        const searchableText = `${session.title} ${session.attendees} ${session.category}`.toLowerCase();
        const matchesSearch = !searchTerm || searchableText.includes(searchTerm);
        console.log(`  - Search match (${searchTerm}):`, matchesSearch);

        // Date filter
        let matchesDate = true;
        const sessionDate = new Date(session.date || session.startTime || session.createdAt);
        
        if (dateRange === 'today') {
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          matchesDate = sessionDate >= today;
        } else if (dateRange === 'week') {
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          matchesDate = sessionDate >= weekAgo;
        } else if (dateRange === 'month') {
          const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
          matchesDate = sessionDate >= monthAgo;
        } else if (dateRange === 'quarter') {
          const quarterAgo = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
          matchesDate = sessionDate >= quarterAgo;
        }
        console.log(`  - Date match (${dateRange}):`, matchesDate);

        // Resident filter - using attendees name
        const matchesResident = resident === 'all' || session.attendees === resident;
        console.log(`  - Resident match (${resident}):`, matchesResident);

        const finalMatch = matchesSearch && matchesDate && matchesResident;
        console.log(`  - Final match:`, finalMatch);
        
        return finalMatch;
      });
      
      console.log(`âœ… Filtered ${filtered.length} sessions from ${allSessions.length} total`);
      return filtered;
    }

    // Render sessions list
    function renderSessions() {
      const callsList = document.getElementById('calls-list');
      const callsTbody = document.getElementById('calls-tbody');
      const emptyState = document.getElementById('empty-state');

      if (filteredSessions.length === 0) {
        callsList.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      callsList.style.display = 'block';
      emptyState.style.display = 'none';

      callsTbody.innerHTML = filteredSessions.map(session => createSessionRow(session)).join('');
    }

    // View session details
    async function viewSessionDetails(sessionId) {
      try {
        console.log(`ðŸ” Viewing details for session ${sessionId}`);
        
        if (window.electronAPI && window.electronAPI.dbGetSessionDetails) {
          const result = await window.electronAPI.dbGetSessionDetails(sessionId);
          
          if (result.success && result.session) {
            const session = result.session;
            const annotations = result.annotations || [];
            const images = result.images || [];
            
            // Display session info
            const sessionInfoHtml = `
              <h3>Session Information</h3>
              <div class="session-info-grid">
                <div class="session-info-item">
                  <span class="session-info-label">Session Title</span>
                  <span class="session-info-value">${session.title || 'Untitled Session'}</span>
                </div>
                <div class="session-info-item">
                  <span class="session-info-label">Date & Time</span>
                  <span class="session-info-value">${new Date(session.start_time || session.created_at).toLocaleString()}</span>
                </div>
                <div class="session-info-item">
                  <span class="session-info-label">Duration</span>
                  <span class="session-info-value">${formatDuration(session.duration)}</span>
                </div>
                <div class="session-info-item">
                  <span class="session-info-label">Doctor</span>
                  <span class="session-info-value">${session.attendees || session.doctor_name || 'Not specified'}</span>
                </div>
                <div class="session-info-item">
                  <span class="session-info-label">Category</span>
                  <span class="session-info-value">${formatCategory(session.category)}</span>
                </div>
                <div class="session-info-item">
                  <span class="session-info-label">Status</span>
                  <span class="session-info-value">${session.status || 'completed'}</span>
                </div>
                <div class="session-info-item">
                  <span class="session-info-label">Total Annotations</span>
                  <span class="session-info-value">${annotations.length}</span>
                </div>
                <div class="session-info-item">
                  <span class="session-info-label">Images</span>
                  <span class="session-info-value">${images.length}</span>
                </div>
              </div>
            `;
            
            // Display annotations
            let annotationsHtml = '<h3>Annotation Details</h3>';
            
            if (annotations.length === 0) {
              annotationsHtml += '<div class="empty-annotations">No annotations found for this session.</div>';
            } else {
              annotations.forEach((annotation, index) => {
                const annotationData = {
                  nerveType: annotation.nerveType || annotation.nerve_type || 'Not specified',
                  sideOfBody: annotation.sideOfBody || annotation.side_of_body || 'Not specified',
                  patientPosition: annotation.patientPosition || annotation.patient_position || 'Not specified',
                  visibility: annotation.visibility || 'Not specified',
                  patientAgeGroup: annotation.patientAgeGroup || annotation.patient_age_group || 'Not specified',
                  needleApproach: annotation.needleApproach || annotation.needle_approach || 'Not specified',
                  clinicalNotes: annotation.clinicalNotes || annotation.clinical_notes || 'No clinical notes provided'
                };
                
                annotationsHtml += `
                  <div class="annotation-card">
                    <div class="annotation-header">
                      <div class="annotation-title">Annotation ${index + 1}</div>
                      <div class="annotation-timestamp">${annotation.timestamp ? new Date(annotation.timestamp).toLocaleString() : 'Time not recorded'}</div>
                    </div>
                    <div class="annotation-details">
                      <div class="annotation-detail">
                        <span class="annotation-detail-label">Nerve Type</span>
                        <span class="annotation-detail-value">${annotationData.nerveType}</span>
                      </div>
                      <div class="annotation-detail">
                        <span class="annotation-detail-label">Side of Body</span>
                        <span class="annotation-detail-value">${annotationData.sideOfBody}</span>
                      </div>
                      <div class="annotation-detail">
                        <span class="annotation-detail-label">Patient Position</span>
                        <span class="annotation-detail-value">${annotationData.patientPosition}</span>
                      </div>
                      <div class="annotation-detail">
                        <span class="annotation-detail-label">Visibility</span>
                        <span class="annotation-detail-value">${annotationData.visibility}</span>
                      </div>
                      <div class="annotation-detail">
                        <span class="annotation-detail-label">Patient Age Group</span>
                        <span class="annotation-detail-value">${annotationData.patientAgeGroup}</span>
                      </div>
                      <div class="annotation-detail">
                        <span class="annotation-detail-label">Needle Approach</span>
                        <span class="annotation-detail-value">${annotationData.needleApproach}</span>
                      </div>
                      <div class="annotation-detail clinical-notes">
                        <span class="annotation-detail-label">Clinical Notes</span>
                        <div class="clinical-notes-content">${annotationData.clinicalNotes}</div>
                      </div>
                    </div>
                  </div>
                `;
              });
            }
            
            // Update modal content
            document.getElementById('sessionInfo').innerHTML = sessionInfoHtml;
            document.getElementById('annotationsList').innerHTML = annotationsHtml;
            
            // Show modal
            document.getElementById('annotationModal').style.display = 'block';
            
          } else {
            console.error('âŒ Failed to load session details:', result.error);
            showToast('Failed to load session details', 'error');
          }
        } else {
          console.error('âŒ Database API not available');
          showToast('Database connection not available', 'error');
        }
      } catch (error) {
        console.error('âŒ Error viewing session details:', error);
        showToast('Error loading session details', 'error');
      }
    }

    // Delete session
    async function deleteSession(sessionId) {
      if (!confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
        return;
      }
      
      try {
        console.log(`ðŸ—‘ï¸ Deleting session ${sessionId}`);
        
        if (window.electronAPI && window.electronAPI.dbDeleteSession) {
          const result = await window.electronAPI.dbDeleteSession(sessionId);
          
          if (result.success) {
            showToast('Session deleted successfully', 'success');
            // Reload sessions from database
            await loadSessionsFromDatabase();
          } else {
            console.error('âŒ Failed to delete session:', result.error);
            showToast('Failed to delete session', 'error');
          }
        } else {
          console.error('âŒ Database API not available');
          showToast('Database connection not available', 'error');
        }
      } catch (error) {
        console.error('âŒ Error deleting session:', error);
        showToast('Error deleting session', 'error');
      }
    }

    // Export session annotations with flattened format
    async function exportSession(sessionId) {
      try {
        console.log(`ðŸ“¤ Exporting session ${sessionId}`);
        
        if (window.electronAPI && window.electronAPI.dbGetSessionDetails) {
          const result = await window.electronAPI.dbGetSessionDetails(sessionId);
          
          if (result.success && result.session) {
            const session = result.session;
            const annotations = result.annotations || [];
            const images = result.images || [];
            
            console.log(`ðŸ“Š Export data: ${annotations.length} annotations, ${images.length} images`);
            
            // Debug: Log first annotation structure
            if (annotations.length > 0) {
              console.log('ðŸ” First annotation structure:', {
                id: annotations[0].id,
                pointsType: typeof annotations[0].points,
                pointsValue: annotations[0].points,
                hasImageId: !!annotations[0].imageId,
                imageId: annotations[0].imageId || annotations[0].image_id
              });
            }
            
            // Debug: Log first image structure
            if (images.length > 0) {
              console.log('ðŸ” First image structure:', {
                id: images[0].id,
                availableFields: Object.keys(images[0]),
                hasData: !!images[0].data,
                hasImageData: !!images[0].imageData,
                hasBase64: !!images[0].base64,
                hasContent: !!images[0].content
              });
            }
            
            // Create flattened annotation-image pairs
            const flattenedAnnotations = annotations.map(annotation => {
              const associatedImage = images.find(img => img.id === annotation.imageId || img.id === annotation.image_id);
              
              // Debug: Log image association for first annotation
              if (annotation === annotations[0]) {
                console.log('ðŸ” Image association for first annotation:', {
                  annotationImageId: annotation.imageId || annotation.image_id,
                  foundImage: !!associatedImage,
                  imageFields: associatedImage ? Object.keys(associatedImage) : 'No image found'
                });
              }
              
              // Safely parse annotation points
              let annotationPoints = [];
              try {
                if (annotation.points) {
                  if (typeof annotation.points === 'string') {
                    annotationPoints = JSON.parse(annotation.points);
                  } else if (Array.isArray(annotation.points)) {
                    annotationPoints = annotation.points;
                  } else if (typeof annotation.points === 'object') {
                    annotationPoints = annotation.points;
                  }
                }
              } catch (error) {
                console.warn('Failed to parse annotation points for annotation', annotation.id, ':', error);
                annotationPoints = [];
              }
              
              // Get image data from multiple possible field names
              let imageData = null;
              if (associatedImage) {
                imageData = associatedImage.image_data || // New database column
                           associatedImage.data || 
                           associatedImage.imageData || 
                           associatedImage.base64 || 
                           associatedImage.content || 
                           associatedImage.file_data ||
                           null;
              }
              
              return {
                // Annotation data
                annotationId: annotation.id,
                annotationTimestamp: annotation.timestamp || annotation.created_at,
                annotationType: annotation.annotationType || annotation.type || 'polygon',
                annotationPoints: annotationPoints,
                
                // Medical attributes
                nerveType: annotation.nerveType || annotation.nerve_type,
                sideOfBody: annotation.sideOfBody || annotation.side_of_body,
                patientPosition: annotation.patientPosition || annotation.patient_position,
                visibility: annotation.visibility,
                patientAgeGroup: annotation.patientAgeGroup || annotation.patient_age_group,
                needleApproach: annotation.needleApproach || annotation.needle_approach,
                clinicalNotes: annotation.clinicalNotes || annotation.clinical_notes,
                
                // Image data paired with annotation
                imageId: annotation.imageId || annotation.image_id,
                imageName: associatedImage?.filename || associatedImage?.name || associatedImage?.file_name || 'Unknown',
                imageData: imageData,
                imageSize: associatedImage?.fileSize || associatedImage?.file_size || associatedImage?.size,
                imageType: associatedImage?.fileType || associatedImage?.file_type || associatedImage?.type || associatedImage?.mimeType,
                imageUploadedAt: associatedImage?.uploadedAt || associatedImage?.uploaded_at || associatedImage?.created_at
              };
            });
            
            // Create export data
            const exportData = {
              sessionInfo: {
                id: session.id,
                title: session.title,
                attendees: session.attendees || session.doctor_name,
                category: session.category,
                startTime: session.start_time || session.startTime,
                endTime: session.end_time || session.endTime,
                duration: session.duration,
                exportTime: new Date().toISOString(),
                totalAnnotations: annotations.length,
                totalImages: images.length,
                status: session.status
              },
              format: 'flattened_annotation_image_pairs',
              description: 'Session export with annotation-image pairs in flattened format from SQLite database',
              annotations: flattenedAnnotations
            };
            
            // Download the export with error handling
            try {
              console.log('ðŸ“ Converting export data to JSON...');
              const dataStr = JSON.stringify(exportData, null, 2);
              console.log('âœ… JSON conversion successful');
              
              const dataBlob = new Blob([dataStr], { type: 'application/json' });
              const url = URL.createObjectURL(dataBlob);
              
              const a = document.createElement('a');
              a.href = url;
              a.download = `session_${session.id}_${session.category || 'annotations'}_${new Date().toISOString().split('T')[0]}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              
              showToast(`Exported ${annotations.length} annotations with images`, 'success');
              console.log(`ðŸ“¤ Successfully exported session "${session.title}" with ${annotations.length} annotations`);
              
            } catch (jsonError) {
              console.error('âŒ Error converting to JSON:', jsonError);
              console.error('Problematic export data:', exportData);
              showToast('Error creating export file - invalid data format', 'error');
            }
            
          } else {
            console.error('âŒ Failed to load session for export:', result.error);
            showToast('Failed to load session data for export', 'error');
          }
        } else {
          console.error('âŒ Database API not available');
          showToast('Database connection not available', 'error');
        }
      } catch (error) {
        console.error('âŒ Error exporting session:', error);
        showToast('Error exporting session', 'error');
      }
    }

    // Toast notification function
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'error' ? '#ef4444' : type === 'info' ? '#3b82f6' : '#10b981'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 500;
        z-index: 2000;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 300px;
        font-size: 0.9rem;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 4000);
    }

    // Logout function
    function logout() {
      try {
        if (typeof window.logout === 'function') {
          window.logout();
        }
      } catch (error) {
        console.log('Logout function not available');
      }
      window.location.href = 'home-clean.html';
    }

    // Add CSS for toast animations
    const toastStyles = document.createElement('style');
    toastStyles.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      .session-date .date { font-weight: 500; }
      .session-date .time { font-size: 0.85rem; color: #94a3b8; }
      .session-title strong { color: #1e293b; }
      .session-category { font-size: 0.75rem; color: #94a3b8; margin-top: 2px; }
      .attendee-name { color: #1e293b; }
      .duration { font-family: monospace; }
      .status { padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; }
      .status-completed { background: rgba(16, 185, 129, 0.1); color: #10b981; }
      .status-archived { background: rgba(107, 114, 128, 0.1); color: #9ca3af; }
      .annotation-stats { text-align: center; }
      .annotation-count { font-weight: 600; font-size: 1.1rem; color: #3b82f6; }
      .annotation-label { font-size: 0.75rem; color: #94a3b8; display: block; }
      .image-count { font-size: 0.75rem; color: #94a3b8; }
    `;
    document.head.appendChild(toastStyles);
  </script>
  
  <!-- Annotation Details Modal -->
  <div id="annotationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Session Annotation Details</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div id="sessionInfo" class="session-info"></div>
        <div id="annotationsList" class="annotations-list"></div>
      </div>
    </div>
  </div>

  <script>
    // Modal event handlers
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('annotationModal');
      const closeBtn = document.querySelector('.close');
      
      // Close modal when clicking the X button
      if (closeBtn) {
        closeBtn.onclick = function() {
          modal.style.display = 'none';
        };
      }
      
      // Close modal when clicking outside of it
      window.onclick = function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      };
      
      // Close modal with Escape key
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      });
    });

    // Test script to verify JavaScript execution
    console.log('ðŸ”§ JavaScript is executing - testing library page');
    console.log('ðŸ”§ Page title:', document.title);
    console.log('ðŸ”§ calls-tbody element exists:', !!document.getElementById('calls-tbody'));
  </script>
</body>
</html>
